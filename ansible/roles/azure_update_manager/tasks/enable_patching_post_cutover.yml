---
# enable_patching_post_cutover.yml
#
# Enables Azure Update Manager patching for a VM that has just been migrated.
# Uses Azure Update Manager scheduled patching approach for VMs without osProfile.

# Expected vars:
#   vm_name                 - Name of the target VM in Azure
#   target_resource_group   - Resource group where the VM lives
#   target_subscription_id  - Subscription that owns the VM
#   patching_schedules_file - Absolute path to vm_patching_schedules.json
#   dry_run                 - Boolean; when true only print what would happen

# â”€â”€ 1. Load patching schedule for this VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: "Patching | Load patching schedules JSON"
  ansible.builtin.set_fact:
    all_patching_schedules: "{{ lookup('file', patching_schedules_file) | from_json }}"

- name: "Patching | Resolve schedule for VM '{{ vm_name }}'"
  ansible.builtin.set_fact:
    vm_patch_schedule: "{{ all_patching_schedules[vm_name | lower] | default({}) }}"

- name: "Patching | Skip VM with no schedule defined"
  ansible.builtin.debug:
    msg: >-
      No patching schedule found for '{{ vm_name }}' in {{ patching_schedules_file }}.
      Skipping patching configuration.
  when: vm_patch_schedule | length == 0

- name: "Patching | End post-cutover patching for this VM (no schedule)"
  ansible.builtin.meta: end_host
  when: vm_patch_schedule | length == 0

# â”€â”€ 2. Derive maintenance window parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: "Patching | Build maintenance window start date-time"
  ansible.builtin.set_fact:
    maint_window_start: "{{ '%Y-%m-%d' | strftime }} {{ vm_patch_schedule.time_of_day | default('02:00') }}"
    maint_config_name: "{{ vm_patch_schedule.maintenance_configuration | default('patch-' ~ vm_name | lower) }}"
    maint_duration: "{{ vm_patch_schedule.duration | default('03:00') }}"
    maint_reboot: "{{ vm_patch_schedule.reboot_setting | default('IfRequired') }}"
    maint_recur_every: >-
      {{
        'Week ' ~ vm_patch_schedule.day_of_week
        if vm_patch_schedule.frequency | default('Weekly') == 'Weekly'
        else vm_patch_schedule.frequency | default('Weekly')
      }}
    maint_description: "{{ vm_patch_schedule.description | default('Patching schedule for ' ~ vm_name) }}"

- name: "Patching | Show resolved schedule"
  ansible.builtin.debug:
    msg:
      - "VM              : {{ vm_name }}"
      - "Config name     : {{ maint_config_name }}"
      - "Recur every     : {{ maint_recur_every }}"
      - "Start time      : {{ maint_window_start }}"
      - "Duration        : {{ maint_duration }}"
      - "Reboot setting  : {{ maint_reboot }}"
      - "Description     : {{ maint_description }}"
      - "Dry run         : {{ dry_run | default(false) }}"

# â”€â”€ 3. Get VM Resource ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: "Patching | Get VM details"
  ansible.builtin.command: >-
    az vm show
    --resource-group "{{ target_resource_group }}"
    --name "{{ vm_name }}"
    --subscription "{{ target_subscription_id }}"
    --query "{id:id, location:location}"
    --output json
  register: vm_details_result
  changed_when: false
  when: not dry_run | default(false) | bool

- name: "Patching | Parse VM details"
  ansible.builtin.set_fact:
    vm_resource_id: "{{ (vm_details_result.stdout | from_json).id }}"
    vm_location: "{{ (vm_details_result.stdout | from_json).location }}"
  when: not dry_run | default(false) | bool and vm_details_result.rc == 0

# â”€â”€ 4. Schedule updates using Azure Update Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: "Patching | Create scheduled patch configuration using Azure Update Manager"
  ansible.builtin.shell: |
    az maintenance configuration create \
      --resource-group "{{ target_resource_group }}" \
      --resource-name "{{ maint_config_name }}" \
      --location "{{ vm_location }}" \
      --maintenance-scope InGuestPatch \
      --subscription "{{ target_subscription_id }}" 2>&1 || echo "Config may already exist"
    
    # Update the configuration with schedule details
    az maintenance configuration update \
      --resource-group "{{ target_resource_group }}" \
      --resource-name "{{ maint_config_name }}" \
      --maintenance-window-duration "{{ maint_duration }}" \
      --maintenance-window-recur-every "{{ maint_recur_every }}" \
      --maintenance-window-start-date-time "{{ maint_window_start }}" \
      --maintenance-window-time-zone UTC \
      --subscription "{{ target_subscription_id }}"
  args:
    executable: /bin/bash
  register: maint_config_result
  changed_when: "'Succeeded' in maint_config_result.stdout or 'succeeded' in maint_config_result.stdout"
  failed_when: false
  when: not dry_run | default(false) | bool

- name: "Patching | Show maintenance configuration result"
  ansible.builtin.debug:
    msg: |
      {% if maint_config_result.rc == 0 -%}
      âœ… Maintenance configuration '{{ maint_config_name }}' created/updated successfully
      {%- else -%}
      âš ï¸  Issue with maintenance configuration: {{ maint_config_result.stderr | default('Unknown error') }}
      {%- endif %}
  when: not dry_run | default(false) | bool

# â”€â”€ 5. Assign maintenance configuration to VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: "Patching | Assign maintenance configuration to VM"
  ansible.builtin.command: >-
    az maintenance assignment create
    --resource-group "{{ target_resource_group }}"
    --location "{{ vm_location }}"
    --resource-name "{{ vm_name }}"
    --resource-type virtualMachines
    --provider-name Microsoft.Compute
    --configuration-assignment-name "{{ maint_config_name }}-assignment"
    --maintenance-configuration-id "/subscriptions/{{ target_subscription_id }}/resourceGroups/{{ target_resource_group }}/providers/Microsoft.Maintenance/maintenanceConfigurations/{{ maint_config_name }}"
    --subscription "{{ target_subscription_id }}"
  register: assignment_result
  changed_when: assignment_result.rc == 0
  failed_when: false
  when: not dry_run | default(false) | bool and maint_config_result.rc == 0

- name: "Patching | Show assignment result"
  ansible.builtin.debug:
    msg: |
      {% if assignment_result.rc == 0 -%}
      âœ… Maintenance configuration assigned to VM '{{ vm_name }}'
      {%- elif 'already exists' in (assignment_result.stderr | default('')) | lower -%}
      â„¹ï¸  Assignment already exists for VM '{{ vm_name }}'
      {%- else -%}
      âš ï¸  Could not assign configuration: {{ assignment_result.stderr | default('Unknown error') }}
      {%- endif %}
  when: not dry_run | default(false) | bool and maint_config_result.rc == 0

# â”€â”€ 6. Verify the assignment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: "Patching | Verify maintenance assignment"
  ansible.builtin.command: >-
    az maintenance assignment list
    --provider-name Microsoft.Compute
    --resource-group "{{ target_resource_group }}"
    --resource-name "{{ vm_name }}"
    --resource-type virtualMachines
    --subscription "{{ target_subscription_id }}"
    --query "[?name=='{{ maint_config_name }}-assignment'].{name:name, status:properties.maintenanceConfigurationId}"
    --output json
  register: verify_assignment
  changed_when: false
  failed_when: false
  when: not dry_run | default(false) | bool

- name: "Patching | Display verification result"
  ansible.builtin.debug:
    msg: |
      {% if verify_assignment.stdout and verify_assignment.stdout != '[]' -%}
      âœ… VERIFIED: Maintenance assignment is active for VM '{{ vm_name }}'
      Assignment details: {{ verify_assignment.stdout }}
      {%- else -%}
      âš ï¸  Could not verify assignment - please check Azure Portal
      {%- endif %}
  when: not dry_run | default(false) | bool and verify_assignment.rc == 0

# â”€â”€ 7. Final summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: "Patching | Post-cutover patching setup summary"
  ansible.builtin.debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… Post-cutover patching configured for: {{ vm_name }}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "  Configuration : {{ maint_config_name }}"
      - "  Schedule      : {{ maint_recur_every }} at {{ vm_patch_schedule.time_of_day | default('02:00') }}"
      - "  Duration      : {{ maint_duration }}"
      - "  Reboot        : {{ maint_reboot }}"
      - "  Location      : {{ vm_location | default('N/A') }}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - ""
      - "ğŸ“‹ Verify in Azure Portal:"
      - "   1. Azure Update Manager â†’ Machines â†’ {{ vm_name }}"
      - "   2. Maintenance Configurations â†’ {{ maint_config_name }}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"