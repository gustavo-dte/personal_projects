---
# enable_patching_post_cutover.yml
# Complete Azure Update Manager patching setup with patch mode fix for Azure Migrate VMs

# Expected vars:
#   vm_name, target_resource_group, target_subscription_id, patching_schedules_file

# ── 1. Load patching schedule ───────────────────────────────────────────────

- name: "Patching | Load patching schedules JSON"
  ansible.builtin.set_fact:
    all_patching_schedules: "{{ lookup('file', patching_schedules_file) | from_json }}"

- name: "Patching | Resolve schedule for VM '{{ vm_name }}'"
  ansible.builtin.set_fact:
    vm_patch_schedule: "{{ all_patching_schedules[vm_name | lower] | default({}) }}"

- name: "Patching | Skip VM with no schedule defined"
  ansible.builtin.debug:
    msg: "No patching schedule found for '{{ vm_name }}'. Skipping."
  when: vm_patch_schedule | length == 0

- name: "Patching | End post-cutover patching for this VM (no schedule)"
  ansible.builtin.meta: end_host
  when: vm_patch_schedule | length == 0

# ── 2. Build schedule parameters ────────────────────────────────────────────

- name: "Patching | Build maintenance window parameters"
  ansible.builtin.set_fact:
    maint_config_name: "{{ vm_patch_schedule.maintenance_configuration | default('patch-' ~ vm_name | lower) }}"
    maint_duration: "{{ vm_patch_schedule.duration | default('03:00') }}"
    maint_reboot: "{{ vm_patch_schedule.reboot_setting | default('IfRequired') }}"
    schedule_day: "{{ vm_patch_schedule.day_of_week | default('Saturday') }}"
    schedule_time: "{{ vm_patch_schedule.time_of_day | default('02:00') }}"
    maint_description: "{{ vm_patch_schedule.description | default('Patching schedule for ' ~ vm_name) }}"

- name: "Patching | Show resolved schedule"
  ansible.builtin.debug:
    msg:
      - "VM: {{ vm_name }}"
      - "Config: {{ maint_config_name }}"
      - "Schedule: Weekly {{ schedule_day }} at {{ schedule_time }}"
      - "Duration: {{ maint_duration }}, Reboot: {{ maint_reboot }}"

# ── 3. Get VM details ───────────────────────────────────────────────────────

- name: "Patching | Get VM resource ID and location"
  ansible.builtin.command: >-
    az vm show
    --resource-group "{{ target_resource_group }}"
    --name "{{ vm_name }}"
    --subscription "{{ target_subscription_id }}"
    --query "{id:id, location:location}"
    --output json
  register: vm_details
  changed_when: false
  when: not dry_run | default(false) | bool

- name: "Patching | Parse VM details"
  ansible.builtin.set_fact:
    vm_resource_id: "{{ (vm_details.stdout | from_json).id }}"
    vm_location: "{{ (vm_details.stdout | from_json).location }}"
  when: not dry_run | default(false) | bool

# ── 4. Set patch mode using Azure REST API ──────────────────────────────────

- name: "Patching | Set patch mode to AutomaticByPlatform using REST API"
  ansible.builtin.shell: |
    az rest \
      --method PATCH \
      --url "{{ vm_resource_id }}?api-version=2024-07-01" \
      --body '{
        "properties": {
          "osProfile": {
            "windowsConfiguration": {
              "patchSettings": {
                "patchMode": "AutomaticByPlatform",
                "automaticByPlatformSettings": {
                  "bypassPlatformSafetyChecksOnUserSchedule": true
                }
              }
            }
          }
        }
      }'
  args:
    executable: /bin/bash
  register: patch_mode_result
  changed_when: patch_mode_result.rc == 0
  failed_when: false
  when: not dry_run | default(false) | bool

- name: "Patching | Show patch mode result"
  ansible.builtin.debug:
    msg: |
      {% if patch_mode_result.rc == 0 -%}
      ✅ Patch mode set to AutomaticByPlatform with bypass enabled
      {%- else -%}
      ⚠️  Could not set patch mode (continuing anyway): {{ patch_mode_result.stderr | default('Unknown error') }}
      {%- endif %}
  when: not dry_run | default(false) | bool

# ── 5. Create maintenance configuration ─────────────────────────────────────

- name: "Patching | Create/Update maintenance configuration"
  ansible.builtin.shell: |
    az rest \
      --method PUT \
      --url "https://management.azure.com/subscriptions/{{ target_subscription_id }}/resourceGroups/{{ target_resource_group }}/providers/Microsoft.Maintenance/maintenanceConfigurations/{{ maint_config_name }}?api-version=2022-11-01-preview" \
      --body '{
        "location": "{{ vm_location }}",
        "tags": {
          "Application": "CorpApps",
          "BillTo": "100000069697",
          "BusinessCriticality": "Tier 4",
          "CreatedBy": "Cloud Platform Team",
          "DataClassification": "Internal",
          "Description": "{{ maint_description }}",
          "Environment": "Development",
          "ItAppOwnerEmail": "cloudplatform@dteenergy.com",
          "Portfolio": "CCOE",
          "Purpose": "VM Patching"
        },
        "properties": {
          "namespace": "Microsoft.Maintenance",
          "extensionProperties": {
            "InGuestPatchMode": "User"
          },
          "maintenanceScope": "InGuestPatch",
          "maintenanceWindow": {
            "startDateTime": "2026-01-01 {{ schedule_time }}",
            "duration": "{{ maint_duration }}",
            "timeZone": "Central Standard Time",
            "recurEvery": "Week {{ schedule_day }}"
          },
          "visibility": "Custom",
          "installPatches": {
            "rebootSetting": "{{ maint_reboot }}",
            "windowsParameters": {
              "kbNumbersToExclude": [],
              "kbNumbersToInclude": [],
              "classificationsToInclude": [
                "Critical",
                "Security"
              ]
            }
          },
          "configurationType": "Regular"
        }
      }'
  args:
    executable: /bin/bash
  register: config_result
  changed_when: config_result.rc == 0
  failed_when: false
  when: not dry_run | default(false) | bool

- name: "Patching | Show configuration result"
  ansible.builtin.debug:
    msg: |
      {% if config_result.rc == 0 -%}
      ✅ Maintenance configuration '{{ maint_config_name }}' created/updated successfully
      {%- else -%}
      ❌ Failed to create configuration: {{ config_result.stderr }}
      {%- endif %}
  when: not dry_run | default(false) | bool

# ── 6. Assign configuration to VM ───────────────────────────────────────────

- name: "Patching | Assign maintenance configuration to VM"
  ansible.builtin.shell: |
    az rest \
      --method PUT \
      --url "{{ vm_resource_id }}/providers/Microsoft.Maintenance/configurationAssignments/{{ maint_config_name }}-assignment?api-version=2022-11-01-preview" \
      --body '{
        "location": "{{ vm_location }}",
        "properties": {
          "maintenanceConfigurationId": "/subscriptions/{{ target_subscription_id }}/resourceGroups/{{ target_resource_group }}/providers/Microsoft.Maintenance/maintenanceConfigurations/{{ maint_config_name }}"
        }
      }'
  args:
    executable: /bin/bash
  register: assign_result
  changed_when: assign_result.rc == 0
  failed_when: false
  when: not dry_run | default(false) | bool and config_result.rc == 0

- name: "Patching | Show assignment result"
  ansible.builtin.debug:
    msg: |
      {% if assign_result.rc == 0 -%}
      ✅ Maintenance configuration assigned to VM '{{ vm_name }}'
      {%- else -%}
      ❌ Assignment failed: {{ assign_result.stderr }}
      {%- endif %}
  when: not dry_run | default(false) | bool and config_result.rc == 0

# ── 7. Verify assignment ────────────────────────────────────────────────────

- name: "Patching | Verify maintenance assignment"
  ansible.builtin.command: >-
    az maintenance assignment list
    --provider-name Microsoft.Compute
    --resource-group "{{ target_resource_group }}"
    --resource-name "{{ vm_name }}"
    --resource-type virtualMachines
    --subscription "{{ target_subscription_id }}"
    --output json
  register: verify_assignment
  changed_when: false
  failed_when: false
  when: not dry_run | default(false) | bool

- name: "Patching | Parse verification result"
  ansible.builtin.set_fact:
    assignment_verified: "{{ (verify_assignment.stdout | from_json | length > 0) if verify_assignment.stdout else false }}"
  when: not dry_run | default(false) | bool and verify_assignment.rc == 0

# ── 8. Final summary ────────────────────────────────────────────────────────

- name: "Patching | Post-cutover patching setup summary"
  ansible.builtin.debug:
    msg:
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "{% if patch_mode_result.rc == 0 and config_result.rc == 0 and assign_result.rc == 0 %}✅{% else %}⚠️{% endif %} Patching Setup for: {{ vm_name }}"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "  Configuration : {{ maint_config_name }}"
      - "  Schedule      : Weekly {{ schedule_day }} at {{ schedule_time }}"
      - "  Duration      : {{ maint_duration }}"
      - "  Reboot        : {{ maint_reboot }}"
      - "  Location      : {{ vm_location | default('N/A') }}"
      - "  Time Zone     : Central Standard Time"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "  Status:"
      - "    Patch Mode   : {% if patch_mode_result.rc == 0 %}✅ Set{% else %}⚠️ Warning{% endif %}"
      - "    Configuration: {% if config_result.rc == 0 %}✅ Created{% else %}❌ Failed{% endif %}"
      - "    Assignment   : {% if assign_result.rc == 0 %}✅ Assigned{% else %}❌ Failed{% endif %}"
      - "    Verification : {% if assignment_verified | default(false) %}✅ Verified{% else %}⚠️ Pending{% endif %}"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - ""
      - "Verify in Azure Portal:"
      - "  • Azure Update Manager → Machines → {{ vm_name }}"
      - "  • Maintenance Configurations → {{ maint_config_name }}"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"