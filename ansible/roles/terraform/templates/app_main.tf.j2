# Generated by Ansible - {{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}
{% if github_workflow_run_url is defined and github_workflow_run_url %}
# Workflow run: {{ github_workflow_run_url }}
{% endif %}

locals {
  {{ app_file_basename }}_resource_prefix = "/subscriptions/${data.azurerm_client_config.current.subscription_id}/resourceGroups/{{ target_resource_group }}"
  {{ app_file_basename }}_vms = {
{% for vm in vms %}
{% set vm_key = vm.target_vm_name | lower | replace('-', '_') %}
    {{ vm_key }} = {
{% if vm.vmss_name is defined %}
      vmss_name                    = "{{ vm.vmss_name }}"
{% else %}
      vmss_name                    = "vmss-{{ vm.target_vm_name }}"
{% endif %}
      vm_name                      = "{{ vm.target_vm_name }}"
      vm_size                      = "{{ vm.target_vm_size }}"
      network = {
        nic_name  = "{{ vm.nic_name }}"
        subnet_id = module.primary_network.subnet_ids["main"]
        network_security_group_id    = {{ '"' ~ vm.network_security_group_id ~ '"' if (vm.network_security_group_id is defined and vm.network_security_group_id) else 'null' }}
        enable_nsg                   = {{ (vm.enable_nsg | default(false)) | lower }}
        nsg_name                     = {{ '"' ~ vm.nsg_name ~ '"' if (vm.nsg_name is defined and vm.nsg_name) else 'null' }}
        nsg_rules                    = {
{% if vm.nsg_rules is defined and vm.nsg_rules %}
{% for rule_name, rule in vm.nsg_rules.items() %}
          "{{ rule_name }}" = {
            priority                   = {{ rule.priority }}
            direction                  = "{{ rule.direction }}"
            access                     = "{{ rule.access }}"
            protocol                   = "{{ rule.protocol }}"
            source_port_range          = "{{ rule.source_port_range | default('*') }}"
            destination_port_range     = "{{ rule.destination_port_range | default('*') }}"
            source_address_prefixes    = {{ (rule.source_address_prefixes | default([])) | to_json }}
            destination_address_prefix = "{{ rule.destination_address_prefix | default('*') }}"
          }
{% endfor %}
{% endif %}
        }
      }
      disk = {
        os = {
          name                 = "{{ vm.os_disk_name }}"
          caching              = "{{ vm.os_disk_caching }}"
          size_gb              = {{ vm.os_disk_size_gb }}
          storage_account_type = "{{ vm.os_disk_storage_account_type }}"
          create_option        = "{{ vm.os_disk_create_option }}"
          os_type              = "{{ vm.os_disk_os_type }}"
        }
        data = {
{% if vm.data_disk_resource_ids is defined and vm.data_disk_resource_ids %}
{% for disk_name, disk in vm.data_disk_resource_ids.items() %}
          "{{ disk_name }}" = {
            lun                       = {{ disk.lun }}
            caching                   = "{{ disk.caching }}"
            write_accelerator_enabled = {{ disk.write_accelerator_enabled | lower }}
            resource_id               = "${local.{{ app_file_basename }}_resource_prefix}/providers/Microsoft.Compute/disks/{{ disk_name }}"
            disk_size_gb              = {{ disk.disk_size_gb }}
            storage_account_type      = "{{ disk.storage_account_type }}"
          }
{% endfor %}
{% endif %}
        }
      }
      vm_resource_id               = "${local.{{ app_file_basename }}_resource_prefix}/providers/Microsoft.Compute/virtualMachines/{{ vm.target_vm_name }}"
      nic_resource_id              = "${local.{{ app_file_basename }}_resource_prefix}/providers/Microsoft.Network/networkInterfaces/{{ vm.nic_name }}"
      os_disk_resource_id          = "${local.{{ app_file_basename }}_resource_prefix}/providers/Microsoft.Compute/disks/{{ vm.os_disk_name }}"
      user_assigned_identity_resource_id = {{ '"' + vm.user_assigned_identity_resource_id + '"' if vm.user_assigned_identity_resource_id is defined else 'null' }}
      backup = {
        enable_backup = {{ vm.backup.enable_backup | default(enable_backup) | lower }}
        backup_vault_name = {{ '"' ~ (vm.backup.backup_vault_name | default(backup_vault_name)) ~ '"' }}
        backup_vault_resource_group_name = {{ '"' ~ (vm.backup.backup_vault_resource_group_name | default(backup_vault_resource_group_name)) ~ '"' }}
        backup_vault_policy_name = {{ '"' ~ (vm.backup.backup_vault_policy_name | default(backup_vault_policy_name)) ~ '"' }}
      }
    }
{% endfor %}
  }
{% if load_balancers is defined and load_balancers %}
  {{ app_file_basename }}_load_balancers = {
{% for lb in load_balancers %}
{% set lb_key = lb.name | lower | replace('-', '_') | replace('.', '_') %}
    {{ lb_key }} = {
      load_balancer_name  = "{{ lb.name }}"
      load_balancer_sku   = {{ '"' ~ lb.load_balancer_sku ~ '"' if (lb.load_balancer_sku is defined and lb.load_balancer_sku) else 'null' }}
      load_balancer_sku_tier = {{ '"' ~ lb.load_balancer_sku_tier ~ '"' if (lb.load_balancer_sku_tier is defined and lb.load_balancer_sku_tier) else 'null' }}
      frontend_ip_configurations = [
{% for fe_ip in lb.frontend_ip_configurations %}
        {
          name = "{{ fe_ip.name }}"
          subnet_id = {% if fe_ip.subnet_id is defined and fe_ip.subnet_id %}module.primary_network.subnet_ids["{{ fe_ip.subnet_id }}"]{% else %}null{% endif %}

          private_ip_address = {{ '"' ~ fe_ip.private_ip_address ~ '"' if (fe_ip.private_ip_address is defined and fe_ip.private_ip_address) else 'null' }}
          private_ip_address_allocation = {{ '"' ~ fe_ip.private_ip_address_allocation ~ '"' if (fe_ip.private_ip_address_allocation is defined and fe_ip.private_ip_address_allocation) else 'null' }}
          public_ip_address_id = {{ '"' ~ fe_ip.public_ip_address_id ~ '"' if (fe_ip.public_ip_address_id is defined and fe_ip.public_ip_address_id) else 'null' }}
          create_public_ip = {{ fe_ip.create_public_ip | lower if (fe_ip.create_public_ip is defined) else 'false' }}
          public_ip_name = {{ '"' ~ fe_ip.public_ip_name ~ '"' if (fe_ip.public_ip_name is defined and fe_ip.public_ip_name) else 'null' }}
          domain_name_label = {{ '"' ~ fe_ip.domain_name_label ~ '"' if (fe_ip.domain_name_label is defined and fe_ip.domain_name_label) else 'null' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
      ]
      health_probes = {
{% if lb.health_probes is defined and lb.health_probes %}
{% for probe_key, probe in lb.health_probes.items() %}
        {{ probe_key }} = {
          name = "{{ probe.name }}"
          port = {{ probe.port }}
          protocol = "{{ probe.protocol }}"
          request_path = {{ '"' ~ probe.request_path ~ '"' if (probe.request_path is defined and probe.request_path) else 'null' }}
          interval_in_seconds = {{ probe.interval_in_seconds if (probe.interval_in_seconds is defined) else 'null' }}
          number_of_probes = {{ probe.number_of_probes if (probe.number_of_probes is defined) else 'null' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
      }
      load_balancer_rules = {
{% if lb.load_balancer_rules is defined and lb.load_balancer_rules %}
{% for rule_key, rule in lb.load_balancer_rules.items() %}
        {{ rule_key }} = {
          name = "{{ rule.name }}"
          protocol = "{{ rule.protocol }}"
          frontend_port = {{ rule.frontend_port }}
          backend_port = {{ rule.backend_port }}
          frontend_ip_configuration_name = "{{ rule.frontend_ip_configuration_name }}"
          backend_pool_name = {{ '"' ~ rule.backend_pool_name ~ '"' if (rule.backend_pool_name is defined and rule.backend_pool_name) else 'null' }}
          probe_name = {{ '"' ~ rule.probe_name ~ '"' if (rule.probe_name is defined and rule.probe_name) else 'null' }}
          floating_ip_enabled = {{ rule.floating_ip_enabled | lower if (rule.floating_ip_enabled is defined) else 'null' }}
          tcp_reset_enabled = {{ rule.tcp_reset_enabled | lower if (rule.tcp_reset_enabled is defined) else 'null' }}
          idle_timeout_in_minutes = {{ rule.idle_timeout_in_minutes if (rule.idle_timeout_in_minutes is defined) else 'null' }}
          load_distribution = {{ '"' ~ rule.load_distribution ~ '"' if (rule.load_distribution is defined and rule.load_distribution) else 'null' }}
          disable_outbound_snat = {{ rule.disable_outbound_snat | lower if (rule.disable_outbound_snat is defined) else 'null' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
      }
      network_interface_ids = [
{%- set valid_nic_count = 0 %}
{%- for vm_name in lb.vm_names %}
{%- set vm_found = vms | selectattr('target_vm_name', 'equalto', vm_name) | list %}
{%- if vm_found | length > 0 %}
{%- set valid_nic_count = valid_nic_count + 1 %}
{%- endif %}
{%- endfor %}
{%- set current_nic_index = 0 %}
{%- for vm_name in lb.vm_names %}
{%- set vm_found = vms | selectattr('target_vm_name', 'equalto', vm_name) | list %}
{%- if vm_found | length > 0 %}
{%- set vm = vm_found[0] %}
{%- set current_nic_index = current_nic_index + 1 %}
        "${local.{{ app_file_basename }}_resource_prefix}/providers/Microsoft.Network/networkInterfaces/{{ vm.nic_name }}"{% if current_nic_index < valid_nic_count %},{% endif %}
{%- endif %}
{%- endfor %}
      ]
      backend_address_pools                         = {{ lb.backend_address_pools | to_json if (lb.backend_address_pools is defined and lb.backend_address_pools) else '{}' }}
      create_availability_set                       = {{ lb.create_availability_set | lower if (lb.create_availability_set is defined) else 'false' }}
      availability_set_name                         = {{ '"' ~ lb.availability_set_name ~ '"' if (lb.availability_set_name is defined and lb.availability_set_name) else 'null' }}
      availability_set_platform_fault_domain_count  = {{ lb.availability_set_platform_fault_domain_count if (lb.availability_set_platform_fault_domain_count is defined) else '2' }}
      availability_set_platform_update_domain_count = {{ lb.availability_set_platform_update_domain_count if (lb.availability_set_platform_update_domain_count is defined) else '5' }}
      availability_set_managed                      = {{ lb.availability_set_managed | lower if (lb.availability_set_managed is defined) else 'false' }}
      tags = merge(
        local.tags,
        {{ lb.tags | default({}) | to_json }}
      )
    }{% if not loop.last %},{% endif %}

{% endfor %}
  }
{% endif %}
{% if app_gateways is defined and app_gateways %}
  {{ app_file_basename }}_app_gateways = {
{% for agw in app_gateways %}
{% set agw_key = agw.name | lower | replace('-', '_') | replace('.', '_') %}
    {{ agw_key }} = {
      application_gateway_name_suffix = "{{ agw.name }}"
      sku_name                        = {{ '"' ~ agw.sku_name ~ '"' if (agw.sku_name is defined and agw.sku_name) else '"Standard_v2"' }}
      sku_tier                        = {{ '"' ~ agw.sku_tier ~ '"' if (agw.sku_tier is defined and agw.sku_tier) else '"Standard_v2"' }}
      sku_capacity                    = {{ agw.sku_capacity if (agw.sku_capacity is defined) else '2' }}
      key_vault_name                          = {{ '"' ~ agw.key_vault_name ~ '"' if (agw.key_vault_name is defined and agw.key_vault_name) else 'null' }}
      key_vault_public_network_access_enabled = {{ agw.key_vault_public_network_access_enabled | lower if (agw.key_vault_public_network_access_enabled is defined) else 'false' }}
      create_private_endpoint                 = {{ agw.create_private_endpoint | lower if (agw.create_private_endpoint is defined) else 'true' }}
      private_endpoint_subnet_id              = {% if agw.private_endpoint_subnet_id is defined and agw.private_endpoint_subnet_id %}module.primary_network.subnet_ids["{{ agw.private_endpoint_subnet_id }}"]{% else %}null{% endif %}

      skip_dns_zone_for_pep                   = {{ agw.skip_dns_zone_for_pep | lower if (agw.skip_dns_zone_for_pep is defined) else 'true' }}
      gateway_ip_configuration = {
        name      = "{{ agw.gateway_ip_configuration.name | default('appgw-ip-config') }}"
        subnet_id = module.primary_network.subnet_ids["{{ agw.gateway_ip_configuration.subnet_id }}"]
      }
      identity_name = {{ '"' ~ agw.identity_name ~ '"' if (agw.identity_name is defined and agw.identity_name) else 'null' }}
      frontend_ip_configurations = [
{% for fe_ip in agw.frontend_ip_configurations %}
        {
          name                            = "{{ fe_ip.name }}"
          subnet_id                       = {% if fe_ip.subnet_id is defined and fe_ip.subnet_id %}module.primary_network.subnet_ids["{{ fe_ip.subnet_id }}"]{% else %}null{% endif %}

          private_ip_address              = {{ '"' ~ fe_ip.private_ip_address ~ '"' if (fe_ip.private_ip_address is defined and fe_ip.private_ip_address) else 'null' }}
          private_ip_address_allocation   = {{ '"' ~ fe_ip.private_ip_address_allocation ~ '"' if (fe_ip.private_ip_address_allocation is defined and fe_ip.private_ip_address_allocation) else '"Static"' }}
          public_ip_address_id            = {{ '"' ~ fe_ip.public_ip_address_id ~ '"' if (fe_ip.public_ip_address_id is defined and fe_ip.public_ip_address_id) else 'null' }}
          create_public_ip                = {{ fe_ip.create_public_ip | lower if (fe_ip.create_public_ip is defined) else 'false' }}
          public_ip_name                  = {{ '"' ~ fe_ip.public_ip_name ~ '"' if (fe_ip.public_ip_name is defined and fe_ip.public_ip_name) else 'null' }}
          domain_name_label               = {{ '"' ~ fe_ip.domain_name_label ~ '"' if (fe_ip.domain_name_label is defined and fe_ip.domain_name_label) else 'null' }}
          private_link_configuration_name = {{ '"' ~ fe_ip.private_link_configuration_name ~ '"' if (fe_ip.private_link_configuration_name is defined and fe_ip.private_link_configuration_name) else 'null' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
      ]
      frontend_ports = {
{% if agw.frontend_ports is defined and agw.frontend_ports %}
{% for port_key, port in agw.frontend_ports.items() %}
        {{ port_key }} = {
          name = "{{ port.name }}"
          port = {{ port.port }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% else %}
        http = {
          name = "http_port"
          port = 80
        }
{% endif %}
      }
      backend_address_pools = {
{% if agw.backend_address_pools is defined and agw.backend_address_pools %}
{% for pool_key, pool in agw.backend_address_pools.items() %}
        {{ pool_key }} = {
          name                  = {{ '"' ~ pool.name ~ '"' if (pool.name is defined and pool.name) else 'null' }}
          fqdns                 = {{ pool.fqdns | default([]) | to_json }}
          ip_addresses          = {{ pool.ip_addresses | default([]) | to_json }}
          network_interface_ids = [
{%- set valid_nic_count = 0 %}
{%- if pool.vm_names is defined %}
{%- for vm_name in pool.vm_names %}
{%- set vm_found = vms | selectattr('target_vm_name', 'equalto', vm_name) | list %}
{%- if vm_found | length > 0 %}
{%- set valid_nic_count = valid_nic_count + 1 %}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- if pool.network_interface_ids is defined %}
{%- for nic_id in pool.network_interface_ids %}
{%- set valid_nic_count = valid_nic_count + 1 %}
{%- endfor %}
{%- endif %}
{%- set current_nic_index = 0 %}
{%- if pool.vm_names is defined %}
{%- for vm_name in pool.vm_names %}
{%- set vm_found = vms | selectattr('target_vm_name', 'equalto', vm_name) | list %}
{%- if vm_found | length > 0 %}
{%- set vm = vm_found[0] %}
{%- set current_nic_index = current_nic_index + 1 %}
            "${local.{{ app_file_basename }}_resource_prefix}/providers/Microsoft.Network/networkInterfaces/{{ vm.nic_name }}"{% if current_nic_index < valid_nic_count %},{% endif %}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- if pool.network_interface_ids is defined %}
{%- for nic_id in pool.network_interface_ids %}
{%- set current_nic_index = current_nic_index + 1 %}
            "{{ nic_id }}"{% if current_nic_index < valid_nic_count %},{% endif %}
{%- endfor %}
{%- endif %}
          ]
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% else %}
        default = {
          name                  = "backend-pool"
          network_interface_ids = [
{%- set valid_nic_count = 0 %}
{%- for vm_name in agw.vm_names %}
{%- set vm_found = vms | selectattr('target_vm_name', 'equalto', vm_name) | list %}
{%- if vm_found | length > 0 %}
{%- set valid_nic_count = valid_nic_count + 1 %}
{%- endif %}
{%- endfor %}
{%- set current_nic_index = 0 %}
{%- for vm_name in agw.vm_names %}
{%- set vm_found = vms | selectattr('target_vm_name', 'equalto', vm_name) | list %}
{%- if vm_found | length > 0 %}
{%- set vm = vm_found[0] %}
{%- set current_nic_index = current_nic_index + 1 %}
            "${local.{{ app_file_basename }}_resource_prefix}/providers/Microsoft.Network/networkInterfaces/{{ vm.nic_name }}"{% if current_nic_index < valid_nic_count %},{% endif %}
{%- endif %}
{%- endfor %}
          ]
        }
{% endif %}
      }
      backend_http_settings = {
{% if agw.backend_http_settings is defined and agw.backend_http_settings %}
{% for setting_key, setting in agw.backend_http_settings.items() %}
        {{ setting_key }} = {
          name                                = "{{ setting.name }}"
          cookie_based_affinity               = {{ '"' ~ setting.cookie_based_affinity ~ '"' if (setting.cookie_based_affinity is defined and setting.cookie_based_affinity) else '"Disabled"' }}
          affinity_cookie_name                = {{ '"' ~ setting.affinity_cookie_name ~ '"' if (setting.affinity_cookie_name is defined and setting.affinity_cookie_name) else 'null' }}
          path                                = {{ '"' ~ setting.path ~ '"' if (setting.path is defined and setting.path) else '"/"' }}
          port                                = {{ setting.port }}
          protocol                            = "{{ setting.protocol }}"
          request_timeout                     = {{ setting.request_timeout if (setting.request_timeout is defined) else '20' }}
          probe_name                          = {{ '"' ~ setting.probe_name ~ '"' if (setting.probe_name is defined and setting.probe_name) else 'null' }}
          host_name                           = {{ '"' ~ setting.host_name ~ '"' if (setting.host_name is defined and setting.host_name) else 'null' }}
          pick_host_name_from_backend_address = {{ setting.pick_host_name_from_backend_address | lower if (setting.pick_host_name_from_backend_address is defined) else 'false' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% else %}
        default = {
          name                  = "http-settings"
          cookie_based_affinity = "Disabled"
          path                  = "/"
          port                  = 80
          protocol              = "Http"
          request_timeout       = 20
        }
{% endif %}
      }
      health_probes = {
{% if agw.health_probes is defined and agw.health_probes %}
{% for probe_key, probe in agw.health_probes.items() %}
        {{ probe_key }} = {
          name                                      = "{{ probe.name }}"
          protocol                                  = "{{ probe.protocol }}"
          path                                      = "{{ probe.path }}"
          host                                      = {{ '"' ~ probe.host ~ '"' if (probe.host is defined and probe.host) else 'null' }}
          interval                                  = {{ probe.interval if (probe.interval is defined) else '30' }}
          timeout                                   = {{ probe.timeout if (probe.timeout is defined) else '30' }}
          unhealthy_threshold                       = {{ probe.unhealthy_threshold if (probe.unhealthy_threshold is defined) else '3' }}
          pick_host_name_from_backend_http_settings = {{ probe.pick_host_name_from_backend_http_settings | lower if (probe.pick_host_name_from_backend_http_settings is defined) else 'false' }}
          minimum_servers                           = {{ probe.minimum_servers if (probe.minimum_servers is defined) else '0' }}
          port                                      = {% if probe.port is defined and probe.port %}{{ probe.port }}{% else %}{% if probe.protocol | lower == 'https' %}443{% else %}80{% endif %}{% endif %}

          match                                     = {{ probe.match | default({}) | to_json if (probe.match is defined and probe.match) else 'null' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
      }
      http_listeners = {
{% if agw.http_listeners is defined and agw.http_listeners %}
{% for listener_key, listener in agw.http_listeners.items() %}
        {{ listener_key }} = {
          name                           = "{{ listener.name }}"
          frontend_ip_configuration_name = "{{ listener.frontend_ip_configuration_name }}"
          frontend_port_name             = "{{ listener.frontend_port_name }}"
          protocol                       = "{{ listener.protocol }}"
          ssl_certificate_name           = {{ '"' ~ listener.ssl_certificate_name ~ '"' if (listener.ssl_certificate_name is defined and listener.ssl_certificate_name) else 'null' }}
          host_name                      = {{ '"' ~ listener.host_name ~ '"' if (listener.host_name is defined and listener.host_name) else 'null' }}
          host_names                     = {{ listener.host_names | default([]) | to_json if (listener.host_names is defined) else '[]' }}
          require_sni                    = {{ listener.require_sni | lower if (listener.require_sni is defined) else 'false' }}
          firewall_policy_id             = {{ '"' ~ listener.firewall_policy_id ~ '"' if (listener.firewall_policy_id is defined and listener.firewall_policy_id) else 'null' }}
          custom_error_configuration     = {{ listener.custom_error_configuration | default([]) | to_json if (listener.custom_error_configuration is defined) else '[]' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
      }
      redirect_configurations = {
{% if agw.redirect_configurations is defined and agw.redirect_configurations %}
{% for redirect_key, redirect in agw.redirect_configurations.items() %}
        {{ redirect_key }} = {
          name                 = "{{ redirect.name }}"
          redirect_type        = "{{ redirect.redirect_type }}"
          target_listener_name = {{ '"' ~ redirect.target_listener_name ~ '"' if (redirect.target_listener_name is defined and redirect.target_listener_name) else 'null' }}
          target_url           = {{ '"' ~ redirect.target_url ~ '"' if (redirect.target_url is defined and redirect.target_url) else 'null' }}
          include_path         = {{ redirect.include_path | lower if (redirect.include_path is defined) else 'false' }}
          include_query_string = {{ redirect.include_query_string | lower if (redirect.include_query_string is defined) else 'false' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
      }
      request_routing_rules = {
{% if agw.request_routing_rules is defined and agw.request_routing_rules %}
{% for rule_key, rule in agw.request_routing_rules.items() %}
        {{ rule_key }} = {
          name                        = "{{ rule.name }}"
          rule_type                   = "{{ rule.rule_type }}"
          http_listener_name          = "{{ rule.http_listener_name }}"
          backend_address_pool_name   = {{ '"' ~ rule.backend_address_pool_name ~ '"' if (rule.backend_address_pool_name is defined and rule.backend_address_pool_name) else 'null' }}
          backend_http_settings_name  = {{ '"' ~ rule.backend_http_settings_name ~ '"' if (rule.backend_http_settings_name is defined and rule.backend_http_settings_name) else 'null' }}
          redirect_configuration_name = {{ '"' ~ rule.redirect_configuration_name ~ '"' if (rule.redirect_configuration_name is defined and rule.redirect_configuration_name) else 'null' }}
          url_path_map_name           = {{ '"' ~ rule.url_path_map_name ~ '"' if (rule.url_path_map_name is defined and rule.url_path_map_name) else 'null' }}
          priority                    = {{ rule.priority if (rule.priority is defined) else 'null' }}
        }{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
      }
      enable_waf = {{ agw.enable_waf | lower if (agw.enable_waf is defined) else 'false' }}
{% if agw.enable_waf is defined and agw.enable_waf and agw.waf_configuration is defined %}
      waf_configuration = {
        firewall_mode            = "{{ agw.waf_configuration.firewall_mode | default('Prevention') }}"
        rule_set_type            = "{{ agw.waf_configuration.rule_set_type | default('OWASP') }}"
        rule_set_version         = "{{ agw.waf_configuration.rule_set_version | default('3.2') }}"
        file_upload_limit_mb     = {{ agw.waf_configuration.file_upload_limit_mb | default(100) }}
        request_body_check       = {{ agw.waf_configuration.request_body_check | default(true) | lower }}
        max_request_body_size_kb = {{ agw.waf_configuration.max_request_body_size_kb | default(128) }}
        disabled_rule_group      = {{ agw.waf_configuration.disabled_rule_group | default([]) | to_json }}
        exclusion                = {{ agw.waf_configuration.exclusion | default([]) | to_json }}
      }
{% else %}
      waf_configuration = null
{% endif %}
      tags = merge(
        local.tags,
        {{ agw.tags | default({}) | to_json }}
      )
    }{% if not loop.last %},{% endif %}

{% endfor %}
  }
{% endif %}
}

module "{{ app_file_basename }}_vms" {
  source  = "app.terraform.io/DTE-Cloud-Platform/imported-vm-pattern/azurerm"
  version = "1.0.6"

  for_each = local.{{ app_file_basename }}_vms

  # Required context
  vm_name             = each.value.vm_name
  resource_group_name = "{{ target_resource_group }}"
  location            = azurerm_resource_group.primary.location
  vm_size             = each.value.vm_size

  # Network
  network = each.value.network

  # Disk
  disk = each.value.disk

  # OS selection
  vm_os_type = lower(each.value.disk.os.os_type)

  # Optional VMSS anchor if vmss_name provided (imports live in root)
  enable_vmss = each.value.vmss_name != null

  # VMSS name for import anchor
  vmss_name = each.value.vmss_name

  # Backup configuration
  enable_backup = each.value.backup.enable_backup
  backup_vault_name    = each.value.backup.backup_vault_name
  backup_vault_resource_group_name = each.value.backup.backup_vault_resource_group_name
  backup_vault_policy_name  = each.value.backup.backup_vault_policy_name

  # Tags
  tags = local.tags
}

{% if load_balancers is defined and load_balancers %}
module "{{ app_file_basename }}_load_balancers" {
  source  = "app.terraform.io/DTE-Cloud-Platform/load-balancer/azurerm"
  version = "1.0.2"

  for_each = local.{{ app_file_basename }}_load_balancers

  load_balancer_name_suffix = each.value.load_balancer_name
  resource_group_name       = "{{ target_resource_group }}"
  location                  = azurerm_resource_group.primary.location
  environment               = var.environment

  load_balancer_sku          = each.value.load_balancer_sku
  load_balancer_sku_tier     = each.value.load_balancer_sku_tier
  frontend_ip_configurations = each.value.frontend_ip_configurations
  health_probes              = each.value.health_probes
  load_balancer_rules        = each.value.load_balancer_rules
  network_interface_ids      = each.value.network_interface_ids

  backend_address_pools                         = try(each.value.backend_address_pools, {})
  create_availability_set                       = try(each.value.create_availability_set, false)
  availability_set_name                         = try(each.value.availability_set_name, null)
  availability_set_platform_fault_domain_count  = try(each.value.availability_set_platform_fault_domain_count, 2)
  availability_set_platform_update_domain_count = try(each.value.availability_set_platform_update_domain_count, 5)
  availability_set_managed                      = try(each.value.availability_set_managed, false)

  tags = try(each.value.tags, {})
}
{% endif %}
{% if app_gateways is defined and app_gateways %}
module "{{ app_file_basename }}_app_gateways" {
  source  = "app.terraform.io/DTE-Cloud-Platform/app-gateway/azurerm"
  version = "0.0.1"

  for_each = local.{{ app_file_basename }}_app_gateways

  application_gateway_name_suffix = each.value.application_gateway_name_suffix
  resource_group_name             = "{{ target_resource_group }}"
  location                        = azurerm_resource_group.primary.location
  environment                     = var.environment == "Development" ? "Dev" : var.environment

  sku_name     = each.value.sku_name
  sku_tier     = each.value.sku_tier
  sku_capacity = each.value.sku_capacity

  gateway_ip_configuration   = each.value.gateway_ip_configuration
  frontend_ip_configurations = each.value.frontend_ip_configurations
  frontend_ports             = each.value.frontend_ports
  backend_address_pools      = each.value.backend_address_pools
  backend_http_settings      = each.value.backend_http_settings
  health_probes              = each.value.health_probes
  http_listeners             = each.value.http_listeners
  redirect_configurations    = try(each.value.redirect_configurations, {})
  request_routing_rules      = each.value.request_routing_rules

  identity_name                           = try(each.value.identity_name, null)
  key_vault_name                          = try(each.value.key_vault_name, null)
  key_vault_public_network_access_enabled = try(each.value.key_vault_public_network_access_enabled, false)
  create_private_endpoint                 = try(each.value.create_private_endpoint, true)
  private_endpoint_subnet_id              = try(each.value.private_endpoint_subnet_id, null)
  skip_dns_zone_for_pep                   = try(each.value.skip_dns_zone_for_pep, false)

  enable_waf        = try(each.value.enable_waf, false)
  waf_configuration = try(each.value.waf_configuration, null)

  tags = each.value.tags
}
{% endif %}

### IMPORT BLOCKS ###
{% for vm in vms %}
{% set vm_key = vm.target_vm_name | lower | replace('-', '_') %}

# Imports for {{ vm.target_vm_name }}
{% if vm.vm_resource_id is defined and vm.vm_resource_id %}
{% if vm.os_disk_os_type | lower == 'linux' %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_linux_virtual_machine.main[0]
  id = "{{ vm.vm_resource_id }}"
}

{% else %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_windows_virtual_machine.main[0]
  id = "{{ vm.vm_resource_id }}"
}

{% endif %}
{% endif %}
{% if vm.nic_resource_id is defined and vm.nic_resource_id %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_network_interface.main
  id = "{{ vm.nic_resource_id }}"
}

{% endif %}
{% if vm.os_disk_resource_id is defined and vm.os_disk_resource_id %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_managed_disk.os_disk
  id = "{{ vm.os_disk_resource_id }}"
}

{% endif %}

{% if vm.data_disk_resource_ids is defined and vm.data_disk_resource_ids %}
{% for disk_name, disk in vm.data_disk_resource_ids.items() %}
{% if disk.resource_id is defined and disk.resource_id %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_managed_disk.data_disk["{{ disk_name }}"]
  id = "{{ disk.resource_id }}"
}

{% endif %}
{% endfor %}
{% endif %}
{% if vm.data_disk_resource_ids is defined and vm.data_disk_resource_ids and vm.vm_resource_id is defined and vm.vm_resource_id %}
{% for disk_name, disk in vm.data_disk_resource_ids.items() %}
{% if disk.resource_id is defined and disk.resource_id %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_virtual_machine_data_disk_attachment.data_disk_attachment["{{ disk_name }}"]
  id = "{{ vm.vm_resource_id }}/dataDisks/{{ disk_name }}"
}

{% endif %}
{% endfor %}
{% endif %}
{% if vm.user_assigned_identity_resource_id is defined %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_user_assigned_identity.identity[0]
  id = "{{ vm.user_assigned_identity_resource_id }}"
}

{% endif %}
{% if vm.vmss_name is defined and vm.vmss_resource_id is defined and vm.vmss_resource_id %}
{% if vm.os_disk_os_type | lower == 'linux' %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_linux_virtual_machine_scale_set.vmss[0]
  id = "{{ vm.vmss_resource_id }}"
}

{% else %}
import {
  to = module.{{ app_file_basename }}_vms["{{ vm_key }}"].azurerm_windows_virtual_machine_scale_set.vmss[0]
  id = "{{ vm.vmss_resource_id }}"
}
{% endif %}
{% endif %}
{%- endfor %}
