// Generated by Ansible - {{ lookup('pipe','date -u +%Y-%m-%dT%H:%M:%SZ') }}

data "azurerm_client_config" "current" {}

locals {
  resource_prefix = "/subscriptions/${data.azurerm_client_config.current.subscription_id}/resourceGroups/${azurerm_resource_group.primary.name}"
  vms = {
{% for vm in vms %}
{% set vm_key = vm.target_vm_name | lower | replace('-', '_') %}
    {{ vm_key }} = {
{% if vm.vmss_name is defined %}
      vmss_name                    = "{{ vm.vmss_name }}"
{% else %}
      vmss_name                    = "vmss-{{ vm.target_vm_name }}"
{% endif %}
      vm_name                      = "{{ vm.target_vm_name }}"
      vm_size                      = "{{ vm.target_vm_size }}"
      network = {
        nic_name  = "{{ vm.nic_name }}"
        subnet_id = module.primary_network.subnet_ids["main"]
        network_security_group_id    = {{ '"' ~ vm.network_security_group_id ~ '"' if (vm.network_security_group_id is defined and vm.network_security_group_id) else 'null' }}
        enable_nsg                   = {{ (vm.enable_nsg | default(false)) | lower }}
        nsg_name                     = {{ '"' ~ vm.nsg_name ~ '"' if (vm.nsg_name is defined and vm.nsg_name) else 'null' }}
        nsg_rules                    = {
{% if vm.nsg_rules is defined and vm.nsg_rules %}
{% for rule_name, rule in vm.nsg_rules.items() %}
          "{{ rule_name }}" = {
            priority                   = {{ rule.priority }}
            direction                  = "{{ rule.direction }}"
            access                     = "{{ rule.access }}"
            protocol                   = "{{ rule.protocol }}"
            source_port_range          = "{{ rule.source_port_range | default('*') }}"
            destination_port_range     = "{{ rule.destination_port_range | default('*') }}"
            source_address_prefixes    = {{ (rule.source_address_prefixes | default([])) | to_json }}
            destination_address_prefix = "{{ rule.destination_address_prefix | default('*') }}"
          }
{% endfor %}
{% endif %}
        }
      }
      disk = {
        os = {
          name                 = "{{ vm.os_disk_name }}"
          caching              = "{{ vm.os_disk_caching }}"
          size_gb              = {{ vm.os_disk_size_gb }}
          storage_account_type = "{{ vm.os_disk_storage_account_type }}"
          create_option        = "{{ vm.os_disk_create_option }}"
          os_type              = "{{ vm.os_disk_os_type }}"
        }
        data = {
{% if vm.data_disk_resource_ids is defined and vm.data_disk_resource_ids %}
{% for disk_name, disk in vm.data_disk_resource_ids.items() %}
          "{{ disk_name }}" = {
            lun                       = {{ disk.lun }}
            caching                   = "{{ disk.caching }}"
            write_accelerator_enabled = {{ disk.write_accelerator_enabled | lower }}
            resource_id               = "${local.resource_prefix}/providers/Microsoft.Compute/disks/{{ disk_name }}"
            disk_size_gb              = {{ disk.disk_size_gb }}
            storage_account_type      = "{{ disk.storage_account_type }}"
          }
{% endfor %}
{% endif %}
        }
      }
      vm_resource_id               = "${local.resource_prefix}/providers/Microsoft.Compute/virtualMachines/{{ vm.target_vm_name }}"
      nic_resource_id              = "${local.resource_prefix}/providers/Microsoft.Network/networkInterfaces/{{ vm.nic_name }}"
      os_disk_resource_id          = "${local.resource_prefix}/providers/Microsoft.Compute/disks/{{ vm.os_disk_name }}"
      user_assigned_identity_resource_id = {{ '"' + vm.user_assigned_identity_resource_id + '"' if vm.user_assigned_identity_resource_id is defined else 'null' }}
    }
{% endfor %}
  }
}

module "vms" {
  source   = "./modules/terraform-azurerm-imported-vm-pattern"
  for_each = local.vms

  # Required context
  vm_name             = each.value.vm_name
  resource_group_name = azurerm_resource_group.primary.name
  location            = azurerm_resource_group.primary.location
  vm_size             = each.value.vm_size

  # Network
  network = each.value.network

  # Disk
  disk = each.value.disk

  # OS selection
  vm_os_type = lower(each.value.disk.os.os_type)

  # Optional VMSS anchor if vmss_name provided (imports live in root)
  enable_vmss = each.value.vmss_name != null

  # VMSS name for import anchor
  vmss_name = each.value.vmss_name

  # Tags
  tags = local.tags
}


### IMPORT BLOCKS ###
{% for vm in vms %}
{% set vm_key = vm.target_vm_name | lower | replace('-', '_') %}

# Imports for {{ vm.target_vm_name }}
{% if vm.os_disk_os_type | lower == 'linux' %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_linux_virtual_machine.main[0]
  id = "${local.resource_prefix}/providers/Microsoft.Compute/virtualMachines/${local.vms["{{ vm_key }}"].vm_name}"
}

{% else %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_windows_virtual_machine.main[0]
  id = "${local.resource_prefix}/providers/Microsoft.Compute/virtualMachines/${local.vms["{{ vm_key }}"].vm_name}"
}

{% endif %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_network_interface.main
  id = "${local.resource_prefix}/providers/Microsoft.Network/networkInterfaces/${local.vms["{{ vm_key }}"].network.nic_name}"
}

import {
  to = module.vms["{{ vm_key }}"].azurerm_managed_disk.os_disk
  id = "${local.resource_prefix}/providers/Microsoft.Compute/disks/${local.vms["{{ vm_key }}"].disk.os.name}"
}

{% if vm.data_disk_resource_ids is defined and vm.data_disk_resource_ids %}
{% for disk_name, disk in vm.data_disk_resource_ids.items() %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_managed_disk.data_disk["{{ disk_name }}"]
  id = "${local.resource_prefix}/providers/Microsoft.Compute/disks/{{ disk_name }}"
}

{% endfor %}
{% endif %}
{% if vm.data_disk_resource_ids is defined and vm.data_disk_resource_ids %}
{% for disk_name, disk in vm.data_disk_resource_ids.items() %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_virtual_machine_data_disk_attachment.data_disk_attachment["{{ disk_name }}"]
  id = "${local.resource_prefix}/providers/Microsoft.Compute/virtualMachines/${local.vms["{{ vm_key }}"].vm_name}/dataDisks/{{ disk_name }}"
}

{% endfor %}
{% endif %}
{% if vm.user_assigned_identity_resource_id is defined %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_user_assigned_identity.identity[0]
  id = "{{ vm.user_assigned_identity_resource_id }}"
}

{% endif %}
{% if vm.vmss_name is defined %}
{% if vm.os_disk_os_type | lower == 'linux' %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_linux_virtual_machine_scale_set.vmss[0]
  id = "${local.resource_prefix}/providers/Microsoft.Compute/virtualMachineScaleSets/${local.vms["{{ vm_key }}"].vmss_name}"
}

{% else %}
import {
  to = module.vms["{{ vm_key }}"].azurerm_windows_virtual_machine_scale_set.vmss[0]
  id = "${local.resource_prefix}/providers/Microsoft.Compute/virtualMachineScaleSets/${local.vms["{{ vm_key }}"].vmss_name}"
}
{% endif %}
{% endif %}
{%- endfor %}
