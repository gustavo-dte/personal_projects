---
- name: Load migration manifest
  ansible.builtin.include_role:
    name: common
    tasks_from: load_manifest
  vars:
    manifest: "{{ manifest }}"

- name: Assert backup_action is valid
  ansible.builtin.assert:
    that:
      - backup_action in backup_actions
    fail_msg: "❌ backup_action must be one of: {{ backup_actions | join(', ') }}"

- name: Extract backup configuration from manifest
  ansible.builtin.set_fact:
    recovery_vault_name: "{{ manifest_data.recovery_vault_name | default('') }}"
    backup_policy_name: "{{ manifest_data.backup_policy_name | default('DefaultPolicy') }}"
    replication_threshold: "{{ manifest_data.replication_threshold | default(80) }}"

- name: Assert required variables for backup operations
  ansible.builtin.assert:
    that:
      - (manifest_data.target_resource_group | default('')) | length > 0
      - (manifest_data.vms | default([])) | length > 0
      - (recovery_vault_name | default('')) | length > 0
      - (manifest_data.azure_migrate_project_name | default('')) | length > 0
    fail_msg: "❌ Required variables missing. Provide target_resource_group, vms list, recovery_vault_name, and azure_migrate_project_name in manifest."


- name: Check replication status using azure_migrate role (always run before backup protection)
  ansible.builtin.include_role:
    name: azure_migrate
    tasks_from: get_replication_status
  vars:
    dry_run: "{{ dry_run | default(false) }}"
  when: backup_action == 'enable_backup_protection'

- name: Include enable backup protection tasks
  ansible.builtin.include_tasks: enable_backup_protection.yml
  when: backup_action == 'enable_backup_protection'
  vars:
    dry_run: "{{ dry_run | default(false) }}"
