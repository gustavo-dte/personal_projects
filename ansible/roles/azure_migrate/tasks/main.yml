---
- name: Load migration manifest
  ansible.builtin.include_role:
    name: common
    tasks_from: load_manifest
  vars:
    manifest: "{{ manifest }}"
  when: migration_action in manifest_dependent_actions

- name: Assert migration_action is valid
  ansible.builtin.assert:
    that:
      - migration_action in migration_actions
    fail_msg: "❌ migration_action must be one of: {{ migration_actions | join(', ') }}"

- name: Compute filtered VM list for stop_replication
  ansible.builtin.set_fact:
    stop_vm_specs: "{{ (manifest_data.vms | default([])) | filter_vm_specs_by_names(vm_names | default('')) }}"
  when: migration_action == 'stop_replication'

- name: Ensure at least one VM specified for stop_replication
  ansible.builtin.assert:
    that:
      - stop_vm_specs | length > 0
    fail_msg: "❌ No VM names provided. Specify vm_names (comma-delimited) or use STOP_ALL to stop replication for all VMs in the manifest."
  when: migration_action == 'stop_replication'

- name: Include start replication tasks
  ansible.builtin.include_tasks: start_replication.yml
  when: migration_action == 'start_replication'
  loop: "{{ manifest_data.vms | default([]) }}"
  loop_control:
    loop_var: vm_spec
    label: "{{ vm_spec.name }}"
  vars:
    vm_name: "{{ vm_spec.name }}"
    azure_migrate_project_name: "{{ manifest_data.azure_migrate_project_name | default('') }}"
    azure_migrate_project_resource_group: "{{ manifest_data.azure_migrate_project_resource_group | default('') }}"
    azure_migrate_subscription_id: "{{ manifest_data.azure_migrate_subscription_id | default('') }}"
    target_resource_group: "{{ vm_spec.target_resource_group | default(manifest_data.target_resource_group | default('')) }}"
    target_subscription_id: "{{ vm_spec.target_subscription_id | default(manifest_data.target_subscription_id | default('')) }}"
    target_network_id: "{{ vm_spec.target_network_id | default(manifest_data.target_network_id | default('')) }}"
    target_subnet_name: "{{ vm_spec.target_subnet_name | default(manifest_data.target_subnet_name | default('')) }}"
    target_vm_size: "{{ vm_spec.target_vm_size | default(manifest_data.target_vm_size | default('')) }}"
    target_license_type: "{{ vm_spec.target_license_type | default(manifest_data.target_license_type | default('')) }}"
    target_disk_type: "{{ vm_spec.target_disk_type | default(manifest_data.target_disk_type | default('')) }}"
    target_vm_name: "{{ vm_spec.target_vm_name | default('') }}"
    os_disk_scsi_id: "{{ vm_spec.os_disk_scsi_id | default(manifest_data.os_disk_scsi_id | default('')) }}"
    dry_run: "{{ dry_run | default(false) }}"

- name: Collect replication results
  ansible.builtin.set_fact:
    all_replication_results: "{{ all_replication_results | default([]) + [vm_result] }}"
  loop: "{{ manifest_data.vms | default([]) }}"
  loop_control:
    loop_var: vm_item
    label: "{{ vm_item.name }}"
  vars:
    vm_result:
      vm_name: "{{ vm_item.name }}"
      status: "{{ 'success' if (all_replication_outputs[vm_item.name].changed | default(false)) else ('already_configured' if (all_replication_outputs[vm_item.name].rc | default(1)) == 0 and not (all_replication_outputs[vm_item.name].changed | default(false)) else 'failed') }}"
      changed: "{{ all_replication_outputs[vm_item.name].changed | default(false) }}"
      error: "{{ all_replication_outputs[vm_item.name].stderr | default('') }}"
      output: "{{ all_replication_outputs[vm_item.name].stdout | default('') }}"
  when: migration_action == 'start_replication' and all_replication_outputs is defined

- name: Display migration replication summary
  ansible.builtin.debug:
    msg:
      - "Migration replication summary:"
      - "Total VMs: {{ manifest_data.vms | default([]) | length }}"
      - "Successful: {{ all_replication_results | default([]) | selectattr('status', 'equalto', 'success') | list | length }}"
      - "Already configured: {{ all_replication_results | default([]) | selectattr('status', 'equalto', 'already_configured') | list | length }}"
      - "Failed: {{ all_replication_results | default([]) | selectattr('status', 'equalto', 'failed') | list | length }}"
      - "VM Details:"
      - "{{ all_replication_results | default([]) | map('combine', {'summary': item.vm_name + ': ' + item.status}) | map(attribute='summary') | list | join('\n  ') }}"
  when: migration_action == 'start_replication' and all_replication_results is defined

- name: Include stop replication tasks
  ansible.builtin.include_tasks: stop_replication.yml
  when: migration_action == 'stop_replication'
  loop: "{{ stop_vm_specs }}"
  loop_control:
    loop_var: vm_spec
    label: "{{ vm_spec.name }}"
  vars:
    vm_name: "{{ vm_spec.name }}"
    azure_migrate_project_name: "{{ manifest_data.azure_migrate_project_name | default('') }}"
    azure_migrate_project_resource_group: "{{ manifest_data.azure_migrate_project_resource_group | default('') }}"
    azure_migrate_subscription_id: "{{ manifest_data.azure_migrate_subscription_id | default('') }}"
    target_resource_group: "{{ vm_spec.target_resource_group | default(manifest_data.target_resource_group | default('')) }}"
    dry_run: "{{ dry_run | default(false) }}"

- name: Collect stop replication results
  ansible.builtin.set_fact:
    all_stop_replication_results: "{{ all_stop_replication_results | default([]) + [vm_result] }}"
  loop: "{{ stop_vm_specs }}"
  loop_control:
    loop_var: vm_item
    label: "{{ vm_item.name }}"
  vars:
    vm_result:
      vm_name: "{{ vm_item.name }}"
      status: "{{ 'success' if (all_stop_replication_outputs[vm_item.name].changed | default(false)) else ('no_replication' if (all_stop_replication_outputs[vm_item.name].rc | default(1)) == 0 and not (all_stop_replication_outputs[vm_item.name].changed | default(false)) else 'failed') }}"
      changed: "{{ all_stop_replication_outputs[vm_item.name].changed | default(false) }}"
      error: "{{ all_stop_replication_outputs[vm_item.name].stderr | default('') }}"
      output: "{{ all_stop_replication_outputs[vm_item.name].stdout | default('') }}"
  when: migration_action == 'stop_replication' and all_stop_replication_outputs is defined

- name: Display migration stop replication summary
  ansible.builtin.debug:
    msg:
      - "Migration stop replication summary:"
      - "Total VMs: {{ manifest_data.vms | default([]) | length }}"
      - "Successful: {{ all_stop_replication_results | default([]) | selectattr('status', 'equalto', 'success') | list | length }}"
      - "No active replication: {{ all_stop_replication_results | default([]) | selectattr('status', 'equalto', 'no_replication') | list | length }}"
      - "Failed: {{ all_stop_replication_results | default([]) | selectattr('status', 'equalto', 'failed') | list | length }}"
      - "VM Details:"
      - "{{ all_stop_replication_results | default([]) | map('combine', {'summary': item.vm_name + ': ' + item.status}) | map(attribute='summary') | list | join('\n  ') }}"
  when: migration_action == 'stop_replication' and all_stop_replication_results is defined

- name: Include list projects tasks
  ansible.builtin.include_tasks: list_projects.yml
  when: migration_action == 'list_projects'
  vars:
    target_resource_group: "{{ resource_group | default('') }}"
    target_subscription_id: "{{ subscription_id | default('') }}"
    dry_run: "{{ dry_run | default(false) }}"

- name: Include get replication status tasks
  ansible.builtin.include_tasks: get_replication_status.yml
  when: migration_action == 'get_replication_status'
  vars:
    dry_run: "{{ dry_run | default(false) }}"

- name: Include cutover tasks
  ansible.builtin.include_tasks: cutover.yml
  when: migration_action == 'cutover'
  loop: "{{ manifest_data.vms | default([]) }}"
  loop_control:
    loop_var: vm_spec
    label: "{{ vm_spec.name }}"
  vars:
    vm_name: "{{ vm_spec.name }}"
    azure_migrate_project_name: "{{ manifest_data.azure_migrate_project_name | default('') }}"
    azure_migrate_project_resource_group: "{{ manifest_data.azure_migrate_project_resource_group | default('') }}"
    target_subscription_id: "{{ vm_spec.target_subscription_id | default(manifest_data.target_subscription_id | default('')) }}"
    target_vm_name: "{{ vm_spec.target_vm_name | default('') }}"
    shutdown_source_vm: "{{ vm_spec.shutdown_source_vm | default(manifest_data.shutdown_source_vm | default(false)) }}"
    dry_run: "{{ dry_run | default(false) }}"
