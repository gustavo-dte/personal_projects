---
# Start test migration using PowerShell cmdlets

- name: Verify prerequisites for start_test_migration
  ansible.builtin.include_role:
    name: common
    tasks_from: azure_verify_prerequisites

- name: Assert additional required variables for start_test_migration
  ansible.builtin.assert:
    that:
      - (azure_migrate_project_name | default('')) | length > 0
      - (azure_migrate_project_resource_group | default('')) | length > 0
      - (azure_migrate_subscription_id | default('')) | length > 0
      - (vm_name | default('')) | length > 0
      - (target_resource_group | default('')) | length > 0
      - (test_network_id | default('')) | length > 0
    fail_msg: |
      Required variables missing. Please provide:
      - azure_migrate_project_name: {{ azure_migrate_project_name | default('NOT SET') }}
      - azure_migrate_project_resource_group: {{ azure_migrate_project_resource_group | default('NOT SET') }}
      - azure_migrate_subscription_id: {{ azure_migrate_subscription_id | default('NOT SET') }}
      - vm_name: {{ vm_name | default('NOT SET') }}
      - target_resource_group: {{ target_resource_group | default('NOT SET') }}
      - test_network_id: {{ test_network_id | default('NOT SET') }}

- name: Initialize test migration skipped flag
  ansible.builtin.set_fact:
    test_migration_skipped: false
    test_migration_skip_reason: ""

- name: Check if replication exists for VM before starting test migration
  block:
    - name: Check replication status for single VM
      ansible.builtin.command: >-
        pwsh -NoLogo -NoProfile -NonInteractive -File
        {{ role_path }}/files/get_replication_status.ps1
        -ProjectName {{ azure_migrate_project_name }}
        -ProjectResourceGroup {{ azure_migrate_project_resource_group | default(target_resource_group) }}
        -VMNamesJson '["{{ vm_name }}"]'
        -SubscriptionId {{ azure_migrate_subscription_id | default('') }}
      register: existing_replication_check
      changed_when: false

    - name: Debug PowerShell output
      ansible.builtin.debug:
        msg: |
          Raw PowerShell output:
          {{ existing_replication_check.stdout }}

    - name: Read JSON results from file
      ansible.builtin.slurp:
        src: get_replication_status_result.json
      register: json_file_content

    - name: Parse JSON content and set replication data
      ansible.builtin.set_fact:
        replication_json: "{{ json_file_content.content | b64decode | from_json }}"

    - name: Debug JSON parsing results
      ansible.builtin.debug:
        msg: |
          JSON Parsing Debug:
          - VM Name: {{ replication_json.VMName | default('N/A') }}
          - Replication Status: {{ replication_json.ReplicationStatus | default('N/A') }}
          - Error Message: {{ replication_json.Error | default('N/A') }}
          - Allowed Operations: {{ (replication_json.AllowedOperationStrings | default([])) | join(', ') }}
          - TestMigrateState: {{ replication_json.TestMigrateStateString | default('N/A') }}
          - TestMigrateStateDescription: {{ replication_json.TestMigrateStateDescriptionString | default('N/A') }}

    - name: Set replication status flags and extract ID
      ansible.builtin.set_fact:
        existing_replication_results: "{{ replication_json }}"
        vm_has_replication: "{{ replication_json.ReplicationStatus is defined and replication_json.ReplicationStatus not in ['Not Found', 'Error'] }}"
        replication_error: "{{ replication_json.ReplicationStatus is defined and replication_json.ReplicationStatus == 'Error' }}"
        replication_error_message: "{{ replication_json.Error | default('Unknown error') }}"
        replication_object_id: "{{ replication_json.ReplicationId | default('') }}"
        allowed_operations: "{{ replication_json.AllowedOperationStrings | default([]) }}"
        allowed_operations_lower: "{{ (replication_json.AllowedOperationStrings | default([])) | map('lower') | list }}"
        test_migrate_state: "{{ replication_json.TestMigrateStateString | default('') }}"
        test_migrate_state_description: "{{ replication_json.TestMigrateStateDescriptionString | default('') }}"

    - name: Compute can_test_migrate flag
      ansible.builtin.set_fact:
        can_test_migrate: "{{ (test_migrate_state | lower == 'none') and ('testmigrate' in allowed_operations_lower) }}"

    - name: Compute unified skip conditions and reason
      ansible.builtin.set_fact:
        test_migration_skipped: >-
          {{
            (not vm_has_replication)
            or ((test_migrate_state | lower == 'none') and not ('testmigrate' in allowed_operations_lower))
            or (test_migrate_state == 'TestMigrationInProgress')
            or (test_migrate_state == 'TestMigrationSucceeded')
          }}
        test_migration_skip_reason: >-
          {{
            (not vm_has_replication)
              | ternary(
                  'No active replication. Test migration can only be started for VMs that are actively replicating. Current replication status: ' ~ (replication_json.ReplicationStatus | default('Unknown')),
                  ((test_migrate_state | lower == 'none') and not ('testmigrate' in allowed_operations_lower))
                    | ternary(
                        'No active test migration. TestMigrate not allowed by provider; skipping.',
                        (test_migrate_state == 'TestMigrationInProgress')
                          | ternary(
                              'Test migration already in progress; skipping.',
                              (test_migrate_state == 'TestMigrationSucceeded')
                                | ternary(
                                    'Test migration already completed (Succeeded); cleanup may be pending.',
                                    ''
                                  )
                            )
                      )
                )
          }}

    - name: Warn when skipping test migration
      ansible.builtin.debug:
        msg: |
          ⚠️  Skipping test migration for VM '{{ vm_name }}'

          Reason: {{ test_migration_skip_reason }}

          Current status:
          - TestMigrateState: {{ test_migrate_state | default('Unknown') }}
          - TestMigrateStateDescription: {{ test_migrate_state_description | default('N/A') }}
          - Allowed operations: {{ allowed_operations | join(', ') }}
      when: test_migration_skipped | default(false)

  rescue:
    - name: Fail when replication status check fails
      ansible.builtin.fail:
        msg: |
          Failed to check replication status for VM '{{ vm_name }}'.
          Error: {{ ansible_failed_result.msg | default('Unknown error') }}
          Cannot start test migration without verifying replication status.

- name: Start test migration using PowerShell file
  when: not (test_migration_skipped | default(false)) and (can_test_migrate | default(false))
  block:
    - name: Debug replication object ID
      ansible.builtin.debug:
        msg: "Replication Object ID to use: {{ replication_object_id }}"
      when: replication_object_id is defined

    - name: Fail if replication object ID is not found
      ansible.builtin.fail:
        msg: |
          ❌ Could not retrieve replication object ID for VM '{{ vm_name }}'

          This is required to start test migration.

          Troubleshooting:
          - Verify the VM has active replication
          - Check replication status
          - Ensure Azure Migrate is properly configured
      when: not (replication_object_id | default('') | length > 0)

    - name: Run start_test_migration.ps1
      ansible.builtin.command: >-
        pwsh -NoLogo -NoProfile -NonInteractive -File
        {{ role_path }}/files/start_test_migration.ps1
        -ProjectName {{ azure_migrate_project_name }}
        -ProjectResourceGroup {{ azure_migrate_project_resource_group | default(target_resource_group) }}
        -ProjectSubscriptionId {{ azure_migrate_subscription_id | default('') }}
        -MachineName {{ vm_name }}
        -TargetObjectId {{ replication_object_id }}
        -TestNetworkId {{ test_network_id }}
      register: test_migration_output
      changed_when: test_migration_output.rc == 0

    - name: Read JSON results from start_test_migration.ps1
      ansible.builtin.slurp:
        src: start_test_migration_result.json
      register: test_migration_json_file

    - name: Parse test migration JSON content
      ansible.builtin.set_fact:
        test_migration_json: "{{ test_migration_json_file.content | b64decode | from_json }}"

    - name: Debug test migration JSON parsing results
      ansible.builtin.debug:
        msg: |
          Test Migration JSON Parsing Debug:
          - VM Name: {{ test_migration_json.VMName | default('N/A') }}
          - Success: {{ test_migration_json.Success | default('N/A') }}
          - Error Message: {{ test_migration_json.Error | default('N/A') }}
          - Job ID: {{ test_migration_json.JobId | default('N/A') }}

  rescue:
    - name: Test migration failed
      ansible.builtin.fail:
        msg: |
          ❌ Test migration failed for VM '{{ vm_name }}'
          Error: {{ test_migration_json.Error | default('Unknown error occurred') }}

          This could be due to:
          - Azure Migrate project not accessible or doesn't exist
          - Insufficient permissions for test migration operations
          - Network connectivity issues
          - Invalid target configuration parameters
          - Replication object not found

          Troubleshooting:
          - Verify Azure Migrate project exists: {{ azure_migrate_project_name }}
          - Check permissions on resource group: {{ azure_migrate_project_resource_group | default(target_resource_group) }}
          - Validate test network configuration
          - Review full output below for specific errors

          Stderr: {{ test_migration_output.stderr | default('') }}

- name: Set skipped test migration results when skipped
  ansible.builtin.set_fact:
    test_migration_output:
      changed: false
      msg: "Test migration skipped: {{ test_migration_skip_reason | default('Test migration already exists') }}"
      stdout: ""
      stderr: ""
      rc: 0
    test_migration_json:
      VMName: "{{ vm_name }}"
      Success: false
      Error: "{{ test_migration_skip_reason | default('Test migration already exists or is in progress') }}"
      JobId: none
      Skipped: true
  when: test_migration_skipped | default(false)

- name: Display test migration result
  ansible.builtin.debug:
    msg:
      - "VM {{ vm_name }}: {{ 'Test migration started' if (test_migration_json.Success | default(false)) else ('Test migration skipped' if (test_migration_json.Skipped | default(false)) else 'Test migration failed') }}"
      - "Changed: {{ test_migration_output.changed | default(false) }}"
      - "Success: {{ test_migration_json.Success | default(false) }}"
      - "Skipped: {{ test_migration_json.Skipped | default(false) }}"
      - "Job ID: {{ test_migration_json.JobId | default('N/A') }}"

- name: Show detailed test migration CLI output
  ansible.builtin.debug:
    var: test_migration_output
  when: ansible_verbosity >= 1

- name: Show detailed test migration JSON result
  ansible.builtin.debug:
    var: test_migration_json
  when: ansible_verbosity >= 1

- name: Set test migration output for main playbook
  ansible.builtin.set_fact:
    test_migration_output: "{{ test_migration_output | default({'changed': false, 'msg': '', 'stdout': '', 'stderr': '', 'rc': 1}) }}"
    test_migration_json: "{{ test_migration_json | default({'VMName': vm_name, 'Success': false, 'Error': 'Test migration was not executed', 'JobId': none, 'Skipped': false}) }}"

- name: Add test migration output to collection
  ansible.builtin.set_fact:
    all_test_migration_outputs: >-
      {{
        all_test_migration_outputs | default({}) | combine({
          vm_name: {
            'changed': test_migration_output.changed | default(false),
            'msg': test_migration_output.msg | default(''),
            'stdout': test_migration_output.stdout | default(''),
            'stderr': test_migration_output.stderr | default(''),
            'test_migration_json': test_migration_json | default({})
          }
        })
      }}
