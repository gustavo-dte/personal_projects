---
# Perform migration cutover using Azure Migrate
# Completes migration by creating target VMs in Azure
# This task is designed to be called in a loop over VMs from a manifest

- name: Skip if dry run
  ansible.builtin.meta: end_play
  when: dry_run | bool

- name: Verify prerequisites for cutover
  ansible.builtin.include_role:
    name: common
    tasks_from: azure_verify_prerequisites

- name: Assert required variables for cutover
  ansible.builtin.assert:
    that:
      - (azure_migrate_project_name | default('')) | length > 0
      - (azure_migrate_project_resource_group | default('')) | length > 0
      - (vm_name | default('')) | length > 0
    fail_msg: |
      Missing required variables for cutover:
      - azure_migrate_project_name: {{ azure_migrate_project_name | default('NOT SET') }}
      - azure_migrate_project_resource_group: {{ azure_migrate_project_resource_group | default('NOT SET') }}
      - vm_name: {{ vm_name | default('NOT SET') }}

- name: Display cutover operation details
  ansible.builtin.debug:
    msg:
      - "Starting cutover operation"
      - "VM: {{ vm_name }}"
      - "Project: {{ azure_migrate_project_name }}"
      - "Resource Group: {{ azure_migrate_project_resource_group }}"
      - "Subscription: {{ target_subscription_id | default('Current') }}"
      - "Shutdown Source: {{ shutdown_source_vm | default(false) }}"

- name: Check current replication status before cutover
  block:
    - name: Get replication status for VM
      ansible.builtin.command: >-
        pwsh -NoLogo -NoProfile -NonInteractive -File
        {{ role_path }}/files/get_replication_status.ps1
        -ProjectName {{ azure_migrate_project_name }}
        -ProjectResourceGroup {{ azure_migrate_project_resource_group }}
        -VMNamesJson '["{{ vm_name }}"]'
        -ReplicationThreshold 0
        -SubscriptionId {{ azure_migrate_subscription_id | default(target_subscription_id | default('')) }}
      register: replication_status_check
      changed_when: false

    - name: Debug PowerShell output
      ansible.builtin.debug:
        msg: |
          Raw PowerShell output:
          {{ replication_status_check.stdout }}

    - name: Read JSON results from file
      ansible.builtin.slurp:
        src: get_replication_status_result.json
      register: json_file_content
      failed_when: false  # Don't fail if file doesn't exist

    - name: Parse JSON content and set replication data
      ansible.builtin.set_fact:
        replication_json: "{{ json_file_content.content | b64decode | from_json }}"
      when: json_file_content.failed is not defined or not json_file_content.failed

    - name: Set default replication data if file read failed
      ansible.builtin.set_fact:
        replication_json:
          VMName: "{{ vm_name }}"
          ReplicationStatus: "Error"
          ReplicationPercentage: 0
          Error: "Failed to read replication status result file"
      when: json_file_content.failed is defined and json_file_content.failed

    - name: Debug JSON parsing results
      ansible.builtin.debug:
        msg: |
          JSON Parsing Debug:
          - Source: JSON file
          - replication_json type: {{ replication_json | type_debug }}
          - VM Name: {{ replication_json.VMName | default('N/A') }}
          - Replication Status: {{ replication_json.ReplicationStatus | default('N/A') }}
          - Error Message: {{ replication_json.Error | default('N/A') }}
          - Full JSON content: {{ replication_json }}

    - name: Compare with start replication results
      ansible.builtin.debug:
        msg: |
          Comparison with Start Replication:
          - Start replication showed VM as 'already_configured'
          - Start replication status was 'Delta sync'
          - Current cutover status is '{{ replication_json.ReplicationStatus | default('N/A') }}'
          - Fixed: Now using azure_migrate_subscription_id for consistency
          - Azure Migrate Subscription: {{ azure_migrate_subscription_id | default('Not set') }}
          - Target Subscription: {{ target_subscription_id | default('Not set') }}

    - name: Parse and validate replication status
      ansible.builtin.set_fact:
        replication_status_results: "{{ replication_json }}"
        vm_ready_for_cutover: "{{ vm_is_ready }}"
        current_replication_status: "{{ current_status }}"
        replication_error: "{{ replication_json.ReplicationStatus is defined and replication_json.ReplicationStatus == 'Error' }}"
        replication_error_message: "{{ replication_json.Error | default('Unknown error') }}"
      vars:
        vm_is_ready: "{{ replication_json.ReplicationStatus is defined and replication_json.ReplicationStatus not in ['Not Found', 'Error', 'Not Replicating', 'Failed', 'Unknown'] }}"
        current_status: "{{ replication_json.ReplicationStatus | default('Unknown') }}"

    - name: Handle "Solution not found" error
      ansible.builtin.fail:
        msg: |
          âŒ Azure Migrate solution not found for VM '{{ vm_name }}'

          This error typically means:
          1. The Azure Migrate project '{{ azure_migrate_project_name }}' doesn't exist
          2. The VM '{{ vm_name }}' hasn't been discovered/assessed yet
          3. The project name or resource group is incorrect
          4. Insufficient permissions to access the Azure Migrate project

          Troubleshooting steps:
          - Verify the Azure Migrate project exists: {{ azure_migrate_project_name }}
          - Check the project resource group: {{ azure_migrate_project_resource_group }}
          - Verify the target subscription ID: {{ target_subscription_id }}
          - Ensure the VM has been discovered and assessed in Azure Migrate
          - Verify you have proper permissions on both Azure Migrate and target subscriptions
          - Check if the VM name matches exactly (case-sensitive)

          Error details: {{ replication_error_message }}
      when: replication_error and "Solution not found" in replication_error_message

  rescue:
    - name: Fail when replication status check fails
      ansible.builtin.fail:
        msg: |
          Failed to check replication status for VM '{{ vm_name }}'.
          Error: {{ ansible_failed_result.msg | default('Unknown error') }}
          Cannot proceed with cutover without valid replication status.

- name: Validate VM is ready for cutover
  block:
    - name: Check for force cutover option
      ansible.builtin.set_fact:
        force_cutover_enabled: "{{ force_cutover | default(false) | bool }}"

    - name: Display warning if forcing cutover
      ansible.builtin.debug:
        msg: |
          âš ï¸  WARNING: Force cutover enabled - bypassing replication status validation

          Current Status: {{ current_replication_status }}
          VM Ready for Cutover: {{ vm_ready_for_cutover }}

          Proceeding with cutover anyway due to force_cutover=true...
      when: force_cutover_enabled and not vm_ready_for_cutover

    - name: Fail if VM is not ready and force is not enabled
      ansible.builtin.fail:
        msg: |
          âŒ VM '{{ vm_name }}' is not ready for cutover.

          Current Status: {{ current_replication_status }}
          VM Ready for Cutover: {{ vm_ready_for_cutover }}

          âš ï¸  IMPORTANT: Discrepancy detected!

          The start replication process showed this VM as 'already_configured' with status 'Delta sync',
          but the cutover replication check shows status '{{ current_replication_status }}'.

          This could indicate:
          1. Different PowerShell scripts using different lookup methods
          2. Timing issue between replication status checks
          3. Different subscription or project context being used
          4. Permission differences between operations

          ðŸ” Debugging Steps:
          1. Check the raw PowerShell output above for detailed error messages
          2. Verify the Azure Migrate project parameters are consistent:
             - Project: {{ azure_migrate_project_name }}
             - Resource Group: {{ azure_migrate_project_resource_group }}
             - Subscription: {{ target_subscription_id | default('Current') }}

          3. Try running the replication status check manually:
             pwsh {{ role_path }}/files/get_replication_status.ps1 -ProjectName "{{ azure_migrate_project_name }}" -ProjectResourceGroup "{{ azure_migrate_project_resource_group }}" -VMNamesJson '["{{ vm_name }}"]' -ReplicationThreshold 0

          4. Compare with the start replication parameters to identify differences

          ðŸ’¡ Possible Solutions:
          - If VM is actually replicating, use: --extra-vars "force_cutover=true"
          - Check Azure portal for actual replication status
          - Verify consistent Azure subscription context

          ðŸ“‹ Full replication data: {{ replication_json }}
      when: not vm_ready_for_cutover and not force_cutover_enabled

- name: Display success message when VM is ready
  ansible.builtin.debug:
    msg: |
      âœ… VM '{{ vm_name }}' is ready for cutover

      Current Status: {{ current_replication_status }}
      Proceeding with cutover operation...
  when: vm_ready_for_cutover or force_cutover_enabled

- name: Perform cutover operation
  block:
    - name: Run cutover.ps1
      ansible.builtin.command: >-
        pwsh -NoLogo -NoProfile -NonInteractive -File
        {{ role_path }}/files/cutover.ps1
        -ProjectName {{ azure_migrate_project_name }}
        -ProjectResourceGroup {{ azure_migrate_project_resource_group }}
        -MachineName {{ vm_name }}
        -SubscriptionId {{ azure_migrate_subscription_id | default('target_subscription_id') | default('') }}
        {{ '-ShutdownSourceVM' if (shutdown_source_vm | default(false)) else '' }}
        {{ ('-TargetVMName ' ~ target_vm_name) if (target_vm_name | default('') | length) > 0 else '' }}
      register: cutover_output
      changed_when: cutover_output.rc == 0
#
    - name: Debug JSON extraction
      ansible.builtin.debug:
        msg:
          - "Raw output length: {{ cutover_output.stdout | length }}"
          - "Extracted JSON string: {{ cutover_json_string | default('Not found') }}"
          - "JSON string type: {{ cutover_json_string | type_debug | default('undefined') }}"
      when: ansible_verbosity >= 1

    - name: Extract JSON from PowerShell output (simple method)
      ansible.builtin.set_fact:
        cutover_json_string: >-
          {{
            cutover_output.stdout.split('\n') | 
            select('regex', '^\\s*[{}"\d]') | 
            join('\n') | 
            regex_replace('\\n\\s*\\n', '\n') | 
            trim
          }}
      when: cutover_output.stdout is defined and cutover_output.stdout | length > 0

    - name: Parse cutover result  
      ansible.builtin.set_fact:
        cutover_result: "{{ cutover_json_string | from_json }}"
      when: cutover_json_string is defined and cutover_json_string | length > 0

    - name: Handle cutover result when JSON not found
      ansible.builtin.set_fact:
        cutover_result:
          Status: "Failed"
          Error: "No JSON result found in PowerShell output"
          Message: "PowerShell script may have failed before producing result"
          ExitCode: "{{ cutover_output.rc }}"
      when: cutover_json_string is not defined or cutover_json_string | length == 0

  rescue:
    - name: Handle JSON parsing errors
      ansible.builtin.set_fact:
        cutover_result:
          Status: "ParseError"
          Error: "Failed to parse JSON from PowerShell output"
          Message: "JSON parsing failed - check output format"
          RawOutput: "{{ cutover_output.stdout | default('') }}"
          ExitCode: "{{ cutover_output.rc | default(-1) }}"
      when: "'JSONDecodeError' in ansible_failed_result.msg"

    - name: Cutover operation failed
      ansible.builtin.fail:
        msg:
          - "Cutover failed for VM '{{ vm_name }}'"
          - "Exit Code: {{ cutover_output.rc | default('Unknown') }}"
          - "Error: {{ cutover_output.stderr | default('Unknown') }}"
          - "Full Output: {{ cutover_output.stdout | default('') }}"
          - "command: pwsh cutover.ps1 with parameters"

- name: Log cutover operation
  ansible.builtin.debug:
    msg: "Triggering log write for {{ vm_name }} cutover"
  vars:
    log_prefix: "AzMigrate_Cutover_"
    log_title: "Migration Cutover"
    operation_output: "{{ cutover_output }}"
  notify: write_operation_log

- name: Flush handlers to write log now
  ansible.builtin.meta: flush_handlers

- name: Display cutover result
  ansible.builtin.debug:
    msg:
      - "Cutover Result"
      - "VM: {{ vm_name }} - {{ cutover_result.Status | default('Unknown') }}"
      - "Message: {{ cutover_result.Message | default('No message') }}"
      - "Target VM: {{ cutover_result.TargetVMName | default('Not specified') }}"
      - "{{ 'Job ID: ' ~ cutover_result.JobId if cutover_result.JobId is defined else '' }}"
      - "Changed: {{ cutover_output.changed | default(false) }}"

- name: Show detailed cutover CLI output
  ansible.builtin.debug:
    var: cutover_output
  when: ansible_verbosity >= 1

- name: Show cutover operation summary
  ansible.builtin.debug:
    msg:
      - "Cutover operation completed for '{{ vm_name }}'"
      - "Status: {{ cutover_result.Status | default('Unknown') }}"
      - "{{ 'Monitor job: ' ~ cutover_result.JobId if cutover_result.JobId is defined and cutover_result.Status == 'Initiated' else '' }}"
      - "{{ 'Manual shutdown may be required' if not (shutdown_source_vm | default(false)) and cutover_result.Status == 'Initiated' else '' }}"
      - "{{ 'Migration already completed' if cutover_result.Status == 'AlreadyCompleted' else '' }}"
      - "{{ 'Migration already in progress - Job: ' ~ cutover_result.CurrentJobName if cutover_result.Status == 'AlreadyInProgress' else '' }}"


