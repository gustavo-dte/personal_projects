---
# Playbook to perform migration cutover for VMs using the azure_migrate role
# Loads VMs from manifest and performs cutover for each VM

- name: Perform migration cutover
  hosts: localhost
  connection: local
  gather_facts: no
  pre_tasks:
    - name: Show Azure account
      block:
        - name: Run 'az account show'
          ansible.builtin.command: az account show -o table
          changed_when: false
      rescue:
        - name: Exit playbook when 'az account show' fails
          ansible.builtin.fail:
            msg: "az account show failed; exiting"

    - name: Display cutover operation warning
      ansible.builtin.debug:
        msg:
          - "WARNING: This playbook performs CUTOVER operations"
          - "This will create target VMs in Azure and complete migration"
          - "Ensure replication is complete before proceeding"
          - "This operation cannot be undone"

    - name: Pause for confirmation
      ansible.builtin.pause:
        prompt: "Proceed with cutover? (yes/no)"
      register: cutover_confirmation

    - name: Validate confirmation
      ansible.builtin.fail:
        msg: "Cutover cancelled by user"
      when: cutover_confirmation.user_input | lower not in ['yes', 'y']

  vars:
    migration_action: cutover
  roles:
    - role: azure_migrate
  post_tasks:
    - name: Cutover operation summary
      ansible.builtin.debug:
        msg:
          - "Cutover operations completed"
          - "Check individual VM results above"
          - "Monitor migration jobs in Azure portal"
          - ""
          - "Next steps:"
          - "1. Monitor migration progress in Azure portal"
          - "2. Verify target VMs are running"
          - "3. Test VM functionality"
          - "4. Shutdown source VMs if needed"
          - "5. Update DNS and networking"