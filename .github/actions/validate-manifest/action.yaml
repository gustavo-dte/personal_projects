name: Validate Ansible Manifest
description: "Validates that the specified manifest directory and file exist"

inputs:
  manifest:
    description: "Manifest name (directory in ansible/vars/)"
    required: true

outputs:
  manifest_path:
    description: "Full path to the validated manifest file"
    value: ${{ steps.validate.outputs.manifest_path }}
  manifest_dir:
    description: "Full path to the validated manifest directory"
    value: ${{ steps.validate.outputs.manifest_dir }}

runs:
  using: composite
  steps:
    - name: Validate manifest
      id: validate
      shell: bash
      env:
        VARS_PATH: "ansible/vars"
      run: |
        MANIFEST="${{ inputs.manifest }}"

        # Security: Validate manifest name (alphanumeric, hyphens, underscores only)
        if [[ ! "${MANIFEST}" =~ ^[a-zA-Z0-9_-]+$ ]] || [[ -z "${MANIFEST}" ]] || [[ ${#MANIFEST} -gt 50 ]]; then
          echo "âŒ ERROR: Invalid manifest name. Use only alphanumeric characters, hyphens, and underscores (max 50 chars)."
          echo "   Provided: '${MANIFEST}'"
          exit 1
        fi

        echo "ðŸ” Validating manifest: ${MANIFEST}"

        # Construct safe paths
        VARS_PATH_ABS=$(realpath "${VARS_PATH}")
        MANIFEST_DIR_ABS=$(realpath "${VARS_PATH_ABS}/${MANIFEST}")
        MANIFEST_FILE_ABS="${MANIFEST_DIR_ABS}/manifest.yml"

        # Security: Ensure path stays within vars directory (prevents path traversal)
        if [[ "${MANIFEST_DIR_ABS}" != "${VARS_PATH_ABS}"/* ]]; then
          echo "âŒ ERROR: Path traversal detected."
          exit 1
        fi

        # Validate files exist
        if [ ! -d "${MANIFEST_DIR_ABS}" ]; then
          echo "âŒ ERROR: Manifest directory '${MANIFEST_DIR_ABS}' does not exist"
          echo "ðŸ“‹ Available manifests:"
          ls -la "${VARS_PATH_ABS}" 2>/dev/null | grep "^d" | awk '{print "  - " $9}' | grep -v "^\s*-\s*\.$" | grep -v "^\s*-\s*\.\.$" || echo "  (none found)"
          exit 1
        fi

        if [ ! -f "${MANIFEST_FILE_ABS}" ]; then
          echo "âŒ ERROR: Manifest file '${MANIFEST_FILE_ABS}' does not exist"
          exit 1
        fi

        echo "âœ… Manifest validation successful!"
        echo "ðŸ“„ Using manifest file: ${MANIFEST_FILE_ABS}"

        # Set outputs
        echo "manifest_path=${MANIFEST_FILE_ABS}" >> $GITHUB_OUTPUT
        echo "manifest_dir=${MANIFEST_DIR_ABS}" >> $GITHUB_OUTPUT
