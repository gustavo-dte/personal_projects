name: Test Service Bus A to B Replication

on:
  workflow_dispatch:
    inputs:
      run_replication_first:
        description: 'Run replication before testing'
        required: false
        default: true
        type: boolean
  
  # Run test after successful replication
  workflow_run:
    workflows: ["Replicate Service Bus A to B"]
    types:
      - completed

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.9'

jobs:
  # Optional job to run replication first
  run-replication:
    name: Run Replication (Optional)
    runs-on: ubuntu-latest
    if: inputs.run_replication_first == true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install azure-servicebus>=7.11.0

      - name: Run Replication
        env:
          SERVICEBUS_A_CONN_STR: ${{ secrets.SERVICEBUS_A_CONN_STR }}
          SERVICEBUS_B_CONN_STR: ${{ secrets.SERVICEBUS_B_CONN_STR }}
          QUEUE_A_NAME: ${{ vars.QUEUE_A_NAME }}
          QUEUE_B_NAME: ${{ vars.QUEUE_B_NAME }}
          BATCH_SIZE: '10'
          MAX_RETRIES: '3'
          REPLICATION_TIMEOUT: '60'  # 1 minute for test
          SKIP_REPLICATED: 'true'
          ADD_METADATA: 'true'
        run: |
          echo "Running replication before test..."
          timeout 60s python replicate_servicebus_a_to_b.py || echo "Replication completed or timed out"

  # Main test job
  test-replication:
    name: Test Replication Functionality
    runs-on: ubuntu-latest
    needs: [run-replication]
    if: always() && (needs.run-replication.result == 'success' || needs.run-replication.result == 'skipped')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install azure-servicebus>=7.11.0

      - name: Validate Test Configuration
        env:
          SERVICEBUS_A_CONN_STR: ${{ secrets.SERVICEBUS_A_CONN_STR }}
          SERVICEBUS_B_CONN_STR: ${{ secrets.SERVICEBUS_B_CONN_STR }}
          QUEUE_A_NAME: ${{ vars.QUEUE_A_NAME }}
          QUEUE_B_NAME: ${{ vars.QUEUE_B_NAME }}
        run: |
          python -c "
          import os
          import sys
          
          required_vars = ['SERVICEBUS_A_CONN_STR', 'SERVICEBUS_B_CONN_STR', 'QUEUE_A_NAME', 'QUEUE_B_NAME']
          missing_vars = [var for var in required_vars if not os.environ.get(var)]
          
          if missing_vars:
              print(f'Missing required environment variables: {missing_vars}')
              sys.exit(1)
          
          print('Test configuration validation passed')
          "

      - name: Run Replication Test
        id: test
        env:
          SERVICEBUS_A_CONN_STR: ${{ secrets.SERVICEBUS_A_CONN_STR }}
          SERVICEBUS_B_CONN_STR: ${{ secrets.SERVICEBUS_B_CONN_STR }}
          QUEUE_A_NAME: ${{ vars.QUEUE_A_NAME }}
          QUEUE_B_NAME: ${{ vars.QUEUE_B_NAME }}
        run: |
          echo "Running Service Bus A to B replication test..."
          echo ""
          
          # Run the test
          python test_replication_simple.py

      - name: Generate Test Report
        if: always()
        run: |
          echo "Service Bus Replication Test Report" > test_report.md
          echo "======================================" >> test_report.md
          echo "" >> test_report.md
          echo "**Test Execution:**" >> test_report.md
          echo "- Workflow: ${{ github.workflow }}" >> test_report.md
          echo "- Run ID: ${{ github.run_id }}" >> test_report.md
          echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> test_report.md
          echo "- Trigger: ${{ github.event_name }}" >> test_report.md
          echo "" >> test_report.md
          echo "**Configuration:**" >> test_report.md
          echo "- Source Queue (A): ${{ vars.QUEUE_A_NAME }}" >> test_report.md
          echo "- Destination Queue (B): ${{ vars.QUEUE_B_NAME }}" >> test_report.md
          echo "- Pre-run Replication: ${{ inputs.run_replication_first || 'false' }}" >> test_report.md
          echo "" >> test_report.md
          echo "**Test Results:**" >> test_report.md
          if [[ "${{ steps.test.outcome }}" == "success" ]]; then
            echo "- **Status: PASSED**" >> test_report.md
            echo "- All test messages were successfully replicated from Service Bus A to Service Bus B" >> test_report.md
            echo "- Replication metadata was properly added" >> test_report.md
          else
            echo "- **Status: FAILED**" >> test_report.md
            echo "- Test messages were not properly replicated" >> test_report.md
            echo "- Check the workflow logs for detailed error information" >> test_report.md
          fi
          echo "" >> test_report.md
          echo "**Next Steps:**" >> test_report.md
          if [[ "${{ steps.test.outcome }}" == "success" ]]; then
            echo "- Replication is working correctly" >> test_report.md
            echo "- Monitor ongoing replication with the scheduled workflow" >> test_report.md
            echo "- Consider adjusting replication frequency if needed" >> test_report.md
          else
            echo "- Check Service Bus connection strings and permissions" >> test_report.md
            echo "- Verify both queues exist and are accessible" >> test_report.md
            echo "- Ensure the replication script is running properly" >> test_report.md
            echo "- Check Azure Service Bus service health" >> test_report.md
          fi
          
          # Display the report
          echo ""
          echo "TEST REPORT:"
          echo "==============="
          cat test_report.md

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: replication-test-report-${{ github.run_number }}
          path: test_report.md
          retention-days: 30

      - name: Post Test Success
        if: success()
        run: |
          echo ""
          echo "ðŸŽ‰ Service Bus replication test PASSED!"
          echo ""
          echo "Key validations completed:"
          echo "  - Messages sent to Service Bus A"
          echo "  - Messages successfully replicated to Service Bus B"
          echo "  - Replication metadata properly added"
          echo "  - No data loss or corruption detected"
          echo ""
          echo "Your Service Bus A to B replication is working correctly! ðŸš€"

      - name: Post Test Failure
        if: failure()
        run: |
          echo ""
          echo "Service Bus replication test FAILED!"
          echo ""
          echo "Common issues to check:"
          echo "  1. Service Bus connection strings"
          echo "  2. Queue names and permissions"
          echo "  3. Network connectivity between zones"
          echo "  4. Azure Service Bus service status"
          echo "  5. Replication script configuration"
          echo ""
          echo "Please review the detailed logs above and the uploaded test report."
