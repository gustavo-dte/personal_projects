name: Replicate Service Bus A to B

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: 'Replication timeout in minutes'
        required: false
        default: '5'
        type: string
      batch_size:
        description: 'Number of messages to process per batch'
        required: false
        default: '10'
        type: string
      ttl_rto_minutes:
        description: 'TTL RTO+delta in minutes (Tier-1 requirement)'
        required: false
        default: '60'
        type: string
      use_topics:
        description: 'Use topics instead of queues (true/false)'
        required: false
        default: 'false'
        type: string
      
  # Scheduled replication (every 15 minutes during business hours)
  schedule:
    - cron: '*/15 6-18 * * 1-5'  # Every 15 minutes, 6 AM to 6 PM, Monday to Friday UTC
    
  # Trigger on specific events (optional)
  repository_dispatch:
    types: [replicate-servicebus]

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.9'

jobs:
  replicate-messages:
    name: Replicate Messages from Service Bus A to B
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install azure-servicebus>=7.11.0

      - name: Validate Service Bus Configuration
        env:
          SERVICEBUS_A_CONN_STR: ${{ secrets.SERVICEBUS_A_CONN_STR }}
          SERVICEBUS_B_CONN_STR: ${{ secrets.SERVICEBUS_B_CONN_STR }}
          QUEUE_A_NAME: ${{ vars.QUEUE_A_NAME }}
          QUEUE_B_NAME: ${{ vars.QUEUE_B_NAME }}
        run: |
          # Validate environment variables are set
          python -c "
          import os
          import sys
          
          required_vars = ['SERVICEBUS_A_CONN_STR', 'SERVICEBUS_B_CONN_STR', 'QUEUE_A_NAME', 'QUEUE_B_NAME']
          missing_vars = [var for var in required_vars if not os.environ.get(var)]
          
          if missing_vars:
              print(f'Missing required environment variables: {missing_vars}')
              sys.exit(1)
          
          # Validate connection string format
          for conn_var in ['SERVICEBUS_A_CONN_STR', 'SERVICEBUS_B_CONN_STR']:
              conn_str = os.environ.get(conn_var)
              if not conn_str.startswith('Endpoint=sb://'):
                  print(f'Invalid connection string format for {conn_var}')
                  sys.exit(1)
          
          print('Service Bus configuration validation passed')
          "

      - name: Test Service Bus Connectivity
        env:
          SERVICEBUS_A_CONN_STR: ${{ secrets.SERVICEBUS_A_CONN_STR }}
          SERVICEBUS_B_CONN_STR: ${{ secrets.SERVICEBUS_B_CONN_STR }}
          QUEUE_A_NAME: ${{ vars.QUEUE_A_NAME }}
          QUEUE_B_NAME: ${{ vars.QUEUE_B_NAME }}
        run: |
          # Test connectivity to both Service Bus instances
          python -c "
          import os
          import asyncio
          from azure.servicebus import ServiceBusClient
          
          async def test_connectivity():
              print('Testing Service Bus connectivity...')
              
              # Test Service Bus A
              try:
                  async with ServiceBusClient.from_connection_string(os.environ['SERVICEBUS_A_CONN_STR']) as client:
                      # Try to get queue properties
                      queue_properties = await client.get_queue(os.environ['QUEUE_A_NAME'])
                      print(f'✅ Service Bus A connected - Queue: {queue_properties.name}')
              except Exception as e:
                  print(f'Service Bus A connection failed: {e}')
                  raise
              
              # Test Service Bus B
              try:
                  async with ServiceBusClient.from_connection_string(os.environ['SERVICEBUS_B_CONN_STR']) as client:
                      # Try to get queue properties
                      queue_properties = await client.get_queue(os.environ['QUEUE_B_NAME'])
                      print(f'✅ Service Bus B connected - Queue: {queue_properties.name}')
              except Exception as e:
                  print(f'Service Bus B connection failed: {e}')
                  raise
          
          asyncio.run(test_connectivity())
          "

      - name: Run Service Bus Replication
        id: replication
        env:
          SERVICEBUS_A_CONN_STR: ${{ secrets.SERVICEBUS_A_CONN_STR }}
          SERVICEBUS_B_CONN_STR: ${{ secrets.SERVICEBUS_B_CONN_STR }}
          QUEUE_A_NAME: ${{ vars.QUEUE_A_NAME }}
          QUEUE_B_NAME: ${{ vars.QUEUE_B_NAME }}
          TOPIC_A_NAME: ${{ vars.TOPIC_A_NAME }}
          TOPIC_B_NAME: ${{ vars.TOPIC_B_NAME }}
          SUBSCRIPTION_A_NAME: ${{ vars.SUBSCRIPTION_A_NAME }}
          SUBSCRIPTION_B_NAME: ${{ vars.SUBSCRIPTION_B_NAME }}
          USE_TOPICS: ${{ inputs.use_topics || vars.USE_TOPICS || 'false' }}
          TTL_RTO_MINUTES: ${{ inputs.ttl_rto_minutes || vars.TTL_RTO_MINUTES || '60' }}
          BATCH_SIZE: ${{ inputs.batch_size || '10' }}
          MAX_RETRIES: ${{ vars.MAX_RETRIES || '3' }}
          REPLICATION_TIMEOUT: ${{ (inputs.timeout_minutes || '5') * 60 }}
          SKIP_REPLICATED: ${{ vars.SKIP_REPLICATED || 'true' }}
          ADD_METADATA: ${{ vars.ADD_METADATA || 'true' }}
          GITHUB_ACTIONS: 'true'
        run: |
          echo "Starting Service Bus A to B replication..."
          echo "Timeout: $(($REPLICATION_TIMEOUT / 60)) minutes"
          echo "Batch size: $BATCH_SIZE"
          echo "Max retries: $MAX_RETRIES"
          echo ""
          
          python replicate_servicebus_a_to_b.py

      - name: Create Replication Report
        if: always()
        run: |
          echo "Service Bus Replication Report" > replication_report.md
          echo "=================================" >> replication_report.md
          echo "" >> replication_report.md
          echo "**Execution Details:**" >> replication_report.md
          echo "- Workflow: ${{ github.workflow }}" >> replication_report.md
          echo "- Run ID: ${{ github.run_id }}" >> replication_report.md
          echo "- Trigger: ${{ github.event_name }}" >> replication_report.md
          echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> replication_report.md
          echo "" >> replication_report.md
          echo "**Configuration:**" >> replication_report.md
          echo "- Source Queue: ${{ vars.QUEUE_A_NAME }}" >> replication_report.md
          echo "- Destination Queue: ${{ vars.QUEUE_B_NAME }}" >> replication_report.md
          echo "- Batch Size: ${{ inputs.batch_size || '10' }}" >> replication_report.md
          echo "- Timeout: ${{ inputs.timeout_minutes || '5' }} minutes" >> replication_report.md
          echo "" >> replication_report.md
          echo "**Results:**" >> replication_report.md
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "- Status: SUCCESS" >> replication_report.md
            echo "- Messages Processed: ${{ steps.replication.outputs.messages_processed || 'N/A' }}" >> replication_report.md
            echo "- Messages Replicated: ${{ steps.replication.outputs.messages_replicated || 'N/A' }}" >> replication_report.md
            echo "- Success Rate: ${{ steps.replication.outputs.success_rate || 'N/A' }}%" >> replication_report.md
          else
            echo "- Status: FAILED" >> replication_report.md
            echo "- Check the workflow logs for error details" >> replication_report.md
          fi
          
          # Display the report
          cat replication_report.md

      - name: Upload Replication Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: replication-report-${{ github.run_number }}
          path: replication_report.md
          retention-days: 30

      - name: Post Success Summary
        if: success()
        run: |
          echo "Service Bus replication completed successfully!"
          echo ""
          echo "Summary:"
          echo "- Messages processed: ${{ steps.replication.outputs.messages_processed || 'Unknown' }}"
          echo "- Messages replicated: ${{ steps.replication.outputs.messages_replicated || 'Unknown' }}"
          echo "- Success rate: ${{ steps.replication.outputs.success_rate || 'Unknown' }}%"
          echo ""
          echo "Next scheduled run: $(date -d '+15 minutes' -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Post Failure Summary
        if: failure()
        run: |
          echo "Service Bus replication failed!"
          echo ""
          echo "Common troubleshooting steps:"
          echo "1. Check Service Bus connection strings"
          echo "2. Verify queue names exist in both Service Bus instances"
          echo "3. Ensure proper permissions for queue access"
          echo "4. Check Azure Service Bus service health"
          echo ""
          echo "For detailed error information, check the workflow logs above."
