name: Ansible-List-Migrate-Projects

# This workflow lists the Azure Migrate projects in a resource group
# It uses the Azure Migrate project name to list the projects

on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: "Azure Resource Group name to list resources from"
        required: true
        type: string
      subscription_id:
        description: "Azure Migrate Subscription ID"
        required: true
        type: string
      dry_run:
        description: "Dry run"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  list-migrate-projects:
    environment: dev
    runs-on:
      - self-hosted
      - linux
      - non-prod
      - vm-migrate
    env:
      ANSIBLE_ROLES_PATH: ansible/roles
      ANSIBLE_CONFIG: ansible/ansible.cfg
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login with user-assigned managed identity
        uses: azure/login@v2
        with:
          auth-type: IDENTITY
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-id: ${{ secrets.VM_MIGRATE_MI_CLIENT_ID }}
          allow-no-subscriptions: true
          enable-AzPSSession: false

      - name: ðŸ”„ Set subscription (optional override)
        if: ${{ inputs.subscription_id != '' && !inputs.dry_run }}
        run: |
          az account set -s "${{ inputs.subscription_id }}"

      - name: ðŸ“Š Display configuration
        run: |
          echo "âœ… Configuration ready!"
          echo "ðŸ“ Resource group: ${{ inputs.resource_group }}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” DRY RUN MODE: Will show commands that would be executed"
          else
            echo "ðŸ“‹ Listing Azure Migrate projects..."
          fi

      - name: ðŸ§± Prepare extra vars file to maintain variable types
        run: |
          cat > ansible_extra_vars.json <<'JSON'
          {
            "resource_group": "${{ inputs.resource_group }}",
            "subscription_id": "${{ inputs.subscription_id }}",
            "dry_run": ${{ inputs.dry_run }}
          }
          JSON

      - name: ðŸŽ¬ Run playbook - list migrate projects
        run: |
          ansible-playbook ansible/playbooks/list-migrate-projects.yml \
            -e @ansible_extra_vars.json

      - name: ðŸ“¤ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: list-projects-logs
          path: ansible/logs/AzMigrate_ListProjects_*.log
          if-no-files-found: warn
          retention-days: 90
