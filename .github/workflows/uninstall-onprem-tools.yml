# To test real uninstall: run workflow_dispatch with dry_run = false and a manifest
# whose VMs exist and have at least one tool from uninstall_tools_list. See docs/UNINSTALL_ONPREM_REVIEW.md.

name: Ansible-Uinstall-Onprem-Tools

on:
  workflow_dispatch:
    inputs:
      manifest:
        description: "Manifest name (directory in ansible/vars/)"
        required: true
        type: string
      dry_run:
        description: "Dry run"
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  uninstall-onprem-tools:
    environment: dev
    runs-on:
      - self-hosted
      - linux
      - non-prod
    env:
      ANSIBLE_ROLES_PATH: ansible/roles
      ANSIBLE_CONFIG: ansible/ansible.cfg
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login with user-assigned managed identity
        uses: azure/login@v2
        with:
          auth-type: IDENTITY
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-id: ${{ secrets.CLIENT_ID_VM_MIGRATE_DEV_CU_MI }}
          allow-no-subscriptions: true
          enable-AzPSSession: false

      - name: Set Azure subscription context
        run: |
          # Load manifest to get subscription ID
          SUBSCRIPTION_ID=$(grep 'target_subscription_id' ansible/vars/${{ inputs.manifest }}/manifest.yml | awk '{print $2}')
          echo "Setting subscription to: $SUBSCRIPTION_ID"
          az account set --subscription "$SUBSCRIPTION_ID"
          echo ""
          echo "Current subscription:"
          az account show

      - name: Check Azure authentication and subscription
        run: |
          echo "Current Azure subscription context:"
          az account show
          echo ""
          echo "Checking resource group: rg-cu-CorpApps-MigrationTest-Dev"
          az group show --name "rg-cu-CorpApps-MigrationTest-Dev" --subscription $(az account show --query id -o tsv) 2>&1 || echo "Resource group not found in current subscription"

      - name: ï¿½ðŸ“Š Display workflow configuration
        run: |
          echo "âœ… Workflow configuration:"
          echo "ðŸ“„ Using manifest: ${{ inputs.manifest }}"
          echo "ðŸ”§ Dry run mode: ${{ inputs.dry_run }}"
          echo "ðŸ—‚ï¸  Output directory: ansible/output"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª Running in DRY RUN mode - Azure lookups will be skipped"
          fi

      - name: ðŸ§± Prepare extra vars file to maintain variable types
        run: |
          cat > ansible_extra_vars.json <<'JSON'
          {
            "manifest": "${{ inputs.manifest }}",
            "dry_run": ${{ inputs.dry_run }}
          }
          JSON

      - name: Run playbook - uninstall onprem tools
        run: |
          ansible-playbook ansible/playbooks/uninstall-onprem-tools.yml \
          -e @ansible_extra_vars.json
