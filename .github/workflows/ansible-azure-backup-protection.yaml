name: Ansible-Azure-Backup-Protection

# This workflow enables Azure Backup protection for VMs based on Azure Migrate replication status
# It checks replication status first, then enables backup protection only for VMs meeting the threshold

on:
  workflow_dispatch:
    inputs:
      manifest:
        description: "Manifest name (directory in ansible/vars/)"
        required: true
        type: string
      dry_run:
        description: "Dry run"
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  azure-backup-protection:
    environment: dev
    runs-on:
      - self-hosted
      - linux
      - non-prod
      - container
      - vm-migrate
    env:
      ANSIBLE_ROLES_PATH: ansible/roles
      ANSIBLE_CONFIG: ansible/ansible.cfg
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âœ… Validate manifest
        uses: ./.github/actions/validate-manifest
        with:
          manifest: ${{ inputs.manifest }}

      - name: ğŸ”§ Setup Ansible and Azure SDKs
        if: ${{ !inputs.dry_run }}
        uses: ./.github/actions/prereq
        with:
          ansible_version: ${{ vars.ANSIBLE_CORE_VERSION || '>=2.15' }}
          collections_requirements: ansible/requirements.yml

      - name: ğŸ” Azure Login
        if: ${{ !inputs.dry_run }}
        uses: ./.github/actions/azure-login
        with:
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ”„ Set subscription (optional override)
        if: ${{ inputs.subscription_id != '' && !inputs.dry_run }}
        run: |
          az account set -s "${{ inputs.subscription_id }}"

      - name: ğŸ“Š Display workflow configuration
        run: |
          echo "âœ… Workflow configuration:"
          echo "ğŸ“„ Using manifest: ${{ inputs.manifest }}"
          echo "ğŸ”§ Dry run mode: ${{ inputs.dry_run }}"
          echo "â„¹ï¸  Backup configuration will be loaded from manifest file"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ğŸ§ª Running in DRY RUN mode - no actual changes will be made"
          fi

      - name: ğŸ¬ Run playbook - Azure Backup Protection
        run: |
          ansible-playbook ansible/playbooks/azure-backup-protection.yml \
            -e "manifest=${{ inputs.manifest }}" \
            -e "dry_run=${{ inputs.dry_run }}"

      - name: ğŸ“¤ Upload Replication Status Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: replication-status-logs
          path: ansible/logs/AzMigrate_GetReplicationStatus_*.log
          if-no-files-found: warn
          retention-days: 90

      - name: ğŸ“¤ Upload Backup Protection Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backup-protection-logs
          path: ansible/logs/AzBackup_EnableBackupProtection_*.log
          if-no-files-found: warn
          retention-days: 90
