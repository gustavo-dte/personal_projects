name: Ansible-Migration-Cutover

# This workflow performs migration cutover for VMs using Azure Migrate
# WARNING: This operation is irreversible and creates target VMs in Azure
# Ensure replication is complete before running this workflow

on:
  workflow_dispatch:
    inputs:
      manifest:
        description: "Manifest name (directory in ansible/vars/)"
        required: true
        type: string
      confirmation:
        description: "Type 'CONFIRM' to proceed with cutover (irreversible operation)"
        required: true
        type: string
      shutdown_source_vm:
        description: "Shutdown source VM after cutover"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Dry run"
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  migration-cutover:
    environment: dev
    runs-on:
      - self-hosted
      - linux
      - non-prod
      - vm-migrate
    env:
      ANSIBLE_ROLES_PATH: ansible/roles
      ANSIBLE_CONFIG: ansible/ansible.cfg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirmation }}" != "CONFIRM" ]; then
            echo "Invalid confirmation. You must type 'CONFIRM' to proceed."
            echo "This is a safety measure for irreversible operations."
            exit 1
          fi
          echo "Confirmation validated. Proceeding with cutover."

      - name: Validate manifest
        uses: ./.github/actions/validate-manifest
        with:
          manifest: ${{ inputs.manifest }}

      - name: Azure Login with user-assigned managed identity
        if: ${{ !inputs.dry_run }}
        uses: azure/login@v2
        with:
          auth-type: IDENTITY
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-id: ${{ secrets.VM_MIGRATE_MI_CLIENT_ID }}
          allow-no-subscriptions: true
          enable-AzPSSession: true

      - name: Display cutover warning and configuration
        run: |
          echo "WARNING: MIGRATION CUTOVER OPERATION"
          echo "This will create target VMs in Azure and complete migration"
          echo "This operation is IRREVERSIBLE once started"
          echo ""
          echo "Configuration validated!"
          echo "Using manifest: ${{ inputs.manifest }}"
          echo "Dry run mode: ${{ inputs.dry_run }}"
          echo "Shutdown source VM: ${{ inputs.shutdown_source_vm }}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "Running in DRY RUN mode - no actual changes will be made"
          else
            echo "Starting migration cutover..."
            if [ "${{ inputs.shutdown_source_vm }}" = "true" ]; then
              echo "Source VMs will be shut down after cutover"
            else
              echo "Source VMs will remain running (manual shutdown required)"
            fi
          fi

      - name: Prepare extra vars file to maintain variable types
        run: |
          cat > ansible_extra_vars.json <<'JSON'
          {
            "manifest": "${{ inputs.manifest }}",
            "shutdown_source_vm": ${{ inputs.shutdown_source_vm }},
            "dry_run": ${{ inputs.dry_run }}
          }
          JSON

      - name: Run playbook - migration cutover
        run: |
          ansible-playbook ansible/playbooks/migration-cutover.yml \
            -e @ansible_extra_vars.json

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-cutover-logs
          path: ansible/logs/AzMigrate_Cutover_*.log
          if-no-files-found: warn
          retention-days: 90

      - name: Post-cutover guidance
        if: success()
        run: |
          echo "Migration cutover workflow completed"
          echo ""
          echo "Next steps:"
          echo "1. Monitor migration jobs in Azure portal"
          echo "2. Verify target VMs are created and running"
          echo "3. Test target VM functionality"
          echo "4. Validate applications are working"
          echo "5. Update DNS and networking as needed"
          echo "6. Shutdown source VMs manually if not done automatically"
          echo ""
          echo "Check uploaded logs for detailed results"
