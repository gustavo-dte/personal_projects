name: Ansible-Join-Windows-Domain

# TODO: This workflow has not been tested yet. Testing is pending due to Windows/Ansible compatibility issues locally.
# The workflow will be validated when run in GitHub Actions (Linux environment where Ansible is fully supported).
# This workflow joins Windows servers to an Active Directory domain
# It uses the manifest to load domain configuration and target VMs

on:
  workflow_dispatch:
    inputs:
      manifest:
        description: "Manifest name (directory in ansible/vars/)"
        required: true
        type: string
      dry_run:
        description: "Dry run"
        required: false
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  join-windows-domain:
    environment: dev
    runs-on:
      - self-hosted
      - linux
      - non-prod
      - vm-migrate
    env:
      ANSIBLE_ROLES_PATH: ansible/roles
      ANSIBLE_CONFIG: ansible/ansible.cfg
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âœ… Validate manifest
        uses: ./.github/actions/validate-manifest
        with:
          manifest: ${{ inputs.manifest }}

      - name: ðŸ“Š Display configuration
        run: |
          echo "âœ… Configuration validated!"
          echo "ðŸ“„ Using manifest: ${{ inputs.manifest }}"
          echo "ðŸ”§ Dry run mode: ${{ inputs.dry_run }}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª Running in DRY RUN mode - no actual changes will be made"
          else
            echo "ðŸš€ Joining Windows servers to domain..."
          fi

      - name: ðŸ§± Prepare extra vars file to maintain variable types
        run: |
          cat > ansible_extra_vars.json <<'JSON'
          {
            "manifest": "${{ inputs.manifest }}",
            "dry_run": ${{ inputs.dry_run }}
          }
          JSON

      - name: ðŸŽ¬ Run playbook - join Windows servers to domain
        run: |
          ansible-playbook ansible/playbooks/join-windows-domain.yaml \
            -e @ansible_extra_vars.json
